#Code to replicate the following:
#Association between mild traumatic brain injury, brain structure, and mental health outcomes in the Adolescent Brain Cognitive Development Study

#packages used
library(dplyr)
library(glmmTMB)
library(brms)
library(mice)
library(tableone)
library(bayestestR)


#check the distribution of pps_y_ss_severity_score
hist(ABCD_TBI$pps_y_ss_severity_score)
#extremely skewed
qqPlot(ABCD_TBI$pps_y_ss_severity_score)
#check the distribution of CBCL Total score
hist(ABCD_TBI$CBCL_total)
qqPlot((ABCD_TBI$CBCL_total))

#checking for overdispersion 
overdisp_fun <- function(Model1) {
  rdf <- df.residual(Model1)
  rp <- residuals(Model1,type="pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
#source: http://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#overdispersion

##we will not show the model building. But extractAIC was used to check AIC of each model.
#variables were retained if they lowered the AIC 
TMB::openmp(16)

system.time(Model_PPS <- glmmTMB(pps_y_ss_severity_score ~ 1+ visit+sex+interview_age+race_ethnicity+
                                   high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                   pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBI_3cat+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                                 family=nbinom2, data=ABCD_TBI,  control = glmmTMBControl(parallel = 16)))
summary(Model_PPS)
#Number of obs: 30249, groups:  src_subject_id, 10722; abcd_site, 22; rel_family_id, 8901
#     AIC      BIC   logLik deviance df.resid 
#133019.5 133285.6 -66477.7 132955.5    30217
#TBI_3catmild TBI                    0.1293809  0.1381882   0.936 0.349136    
#TBI_3catpossible mild TBI           0.1605525  0.0887865   1.808 0.070560 .


exp(confint(Model_PPS))
#                                           2.5 %       97.5 %      Estimate 
#cond.TBI_3catmild TBI                     0.8680874    1.4921601   1.1381236
#cond.TBI_3catpossible mild TBI            0.9866244    1.3973406   1.1741594



#30249/33515 #about 9.75% of observations are removed
#####


system.time(Model_CBCL <- glmmTMB(CBCL_total ~ 1+ visit+sex+interview_age+race_ethnicity+
                                    high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                    pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBI_3cat+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                              family=nbinom2, data=ABCD_TBI,  control = glmmTMBControl(parallel = 16)))
#   user  system elapsed 
#1055.52    4.92  120.22 
summary(Model_CBCL)
#TBI_3catmild TBI                    0.1413491  0.0461184   3.065 0.002177 ** 
#TBI_3catpossible mild TBI           0.0703450  0.0291948   2.410 0.015974 *  
exp(confint(Model_CBCL))
#                                          2.5 %       97.5 %   Estimate
# cond.TBI_3catmild TBI                   1.0522795  1.2607911  1.1518266
# cond.TBI_3catpossible mild TBI          1.0132108  1.1360595  1.0728782
#Number of obs: 30251, groups:  src_subject_id, 10722; abcd_site, 22; rel_family_id, 8901


exp(confint(Model_CBCL))
#cond.TBI_3catmild TBI                   1.0522795  1.2607911  1.1518266
#cond.TBI_3catpossible mild TBI          1.0132108  1.1360595  1.0728782

30251/33515 #9.74% of observations removed 
#######

################################################################################
#imputation 

#FIRST STEP : MISSING DATA INSPECTION

colSums(is.na(ABCD_TBI))


round(colSums(is.na(ABCD_TBI))/nrow(ABCD_TBI)*100,2)
#household_income        FH_Psychosis 
#      8.23                   1.19

md.pattern(ABCD_TBI)
md.pairs(ABCD_TBI)$mr

#separating the variables I need
dat1 <- ABCD_TBI[, c("src_subject_id", "visit", "rel_family_id", "abcd_site", "pps_y_ss_severity_score", "sex", "interview_age", 
                     "race_ethnicity", "household.income.bl", "rel_relationship", "neighborhood_crime_y", "high.educ.bl", "FH_Psychosis", "TBI_3cat", "marital_allvisits",
                     "pmq_y_ss_mean")]

#convert id to an integer
dat1$src_subject_id <- as.integer(dat1$src_subject_id)

#converting all character to factor
dat1[sapply(dat1, is.character)] <- lapply(dat1[sapply(dat1, is.character)], 
                                           as.factor)
str(dat1)


ini <- mice(dat1, maxit=0) #dat1 is already in long form. 
method <- ini$method
method["household.income.bl"] <- "pmm"  #using predictive mean matching for household income
pred <- ini$pred
pred["household.income.bl", ] <- c(-2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
#0 means not included in imputation model, 1 denotes fixed effect, 2 a fixed and random effect, 
#-2 identifies the class variable.

ini$predictorMatrix

pred #predictormatrix

#20 imputations with 20 iterations and 3 donors. 
system.time(imp.pmm2 <- parlmice(dat1, cluster.seed=123453, method = method, pred = pred, maxit=20, donors=3, n.core=10, n.imp.core=2,  print = TRUE))
summary(imp.pmm2)
# user  system elapsed 
# 7.32    2.29 2562.28 
#################
#pooling the data sets for parameter estimation 
#################

cor2fisher <- function(r) {(1/2*log( ( 1 + r) / ( 1 - r ) ))  }
fisher2cor <- function(z) {( exp(2*z) - 1 )/ ( exp(2*z) + 1 ) }

est <- se <- rvar <- rcor <- vector(length=100, mode= "list")

for (i in 1:20) {
  cat(i, "\n")
  com <- complete(imppmm3, i)
  nb2modelFull1 <- glmmTMB::glmmTMB(pps_y_ss_severity_score ~ 1+ visit+sex+interview_age+race_ethnicity+
                                      high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                      pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBI_3cat+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                                    family=nbinom2, data=com,  control = glmmTMBControl(parallel = 16))
  s <- summary(nb2modelFull1)
  est[[i]] <- s$coefficients$cond[, 1]
  se[[i]] <- s$coefficients$cond[, 2]
  rvar[[i]] <- 
    attr(glmmTMB::VarCorr(nb2modelFull1)[[1]]$"src_subject_id", "stddev")^2
  #rcor[[i]] <- cor2fisher(attr(
  # glmmTMB::VarCorr(nb2modelFull1)[[1]]$"ID",
  #"correlation"
  
}

s

#TBI_3catmild TBI                    0.195216   0.132103   1.478 0.139472    
#TBI_3catpossible mild TBI           0.190585   0.083686   2.277 0.022763 *      
 
 
exp(confint(nb2modelFull1))
#                                           2.5 %       97.5 %    Estimate
#cond.TBI_3catmild TBI                     0.9382862    1.5748074   1.2155740
#cond.TBI_3catpossible mild TBI            1.0269197    1.4256194   1.2099573
options(digits=6)
 
 
######

#diagnostics of the imputation 

compare.percent.count <- function(orig,imp,counts){
  nam=names(orig[colSums(is.na(orig))>0])
  nam = nam[nam %in% counts]
  output <- vector(length(nam), mode="list")
  names(output)<-nam
  for (i in 1:length(nam)){
    data <- mice::complete(imp,"long")
    ry= is.na(orig[,nam[i]])
    ry[ry==TRUE]<-"imputed"
    ry[ry==FALSE]<-"observed"
    data <- cbind(data,ry)
    colnames(data)[length(colnames(data))]<-paste0("R.",nam[i])
    tab <- table(data[,nam[i]],data[,paste0("R.",nam[i])])
    
    
    output[[i]]<- rbind("imputed"=round(tab[,1]/sum(tab[,1])*100,2),
                        "observed"=round(tab[,2]/sum(tab[,2])*100,2))
    
  }
  return(output)
}

result <- compare.percent.count(orig=dat1, imp=imp.pmm2, counts= c("household.income.bl"))
result
# $household.income.bl
#           [<50K] [>=50K & <100K] [>=100K]
# imputed   50.29           24.81    24.91
# observed  28.76           28.56    42.69
######

#now doing the same for CBCL total 
 
dat2 <- ABCD_TBI[, c("src_subject_id", "visit", "rel_family_id", "abcd_site", "pps_y_ss_severity_score", "sex", "interview_age", 
                     "race_ethnicity", "household.income.bl", "rel_relationship", "neighborhood_crime_y", "high.educ.bl", "FH_Psychosis", "TBI_3cat", "marital_allvisits",
                     "pmq_y_ss_mean", "CBCL_total")]

#convert id to an integer
dat2$src_subject_id <- as.integer(dat2$src_subject_id)

#converting all character to factor
dat2[sapply(dat2, is.character)] <- lapply(dat2[sapply(dat2, is.character)], 
                                           as.factor)
str(dat2)


ini <- mice(dat2, maxit=0) #dat2 is already in long form. 
method <- ini$method
method["household.income.bl"] <- "pmm"  #using predictive mean matching for household income
pred <- ini$pred
pred["household.income.bl", ] <- c(-2, 2, 2, 2, 1, 1, 1, 1, 1,1,1, 1,1, 1, 1, 1, 1)
#0 means not included in imputation model, 1 denotes fixed effect, 2 a fixed and random effect, 
#-2 identifies the class variable.

ini$predictorMatrix

pred #predictormatrix

 

#20 imputed datasets with 20 iterations and 3 donors
system.time(imp.pmm3 <- parlmice(dat2, cluster.seed=123453, method = method, pred = pred, maxit=20, donors=3, n.core=10, n.imp.core=2,  print = TRUE))
plot(imp.pmm3, 1:3)
#   user  system elapsed 

# user  system elapsed 
# 12.19    4.51 4389.87 


summary(imp.pmm3)
saveRDS(imp.pmm3, "imppmm3.RDS")
########################
#pooling the data sets for parameter estimation 


cor2fisher <- function(r) {(1/2*log( ( 1 + r) / ( 1 - r ) ))  }
fisher2cor <- function(z) {( exp(2*z) - 1 )/ ( exp(2*z) + 1 ) }

est <- se <- rvar <- rcor <- vector(length=100, mode= "list")

for (i in 1:20) {
  cat(i, "\n")
  com1 <- complete(imppmm3, i)
  nb2modelFull2 <- glmmTMB::glmmTMB(CBCL_total ~  1+ visit+sex+interview_age+race_ethnicity+
                                      high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                      pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBI_3cat+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                                    family=nbinom2, data=com1,  control = glmmTMBControl(parallel = 16))
  s <- summary(nb2modelFull2)
  est[[i]] <- s$coefficients$cond[, 1]
  se[[i]] <- s$coefficients$cond[, 2]
  rvar[[i]] <- 
    attr(glmmTMB::VarCorr(nb2modelFull2)[[1]]$"src_subject_id", "stddev")^2
  #rcor[[i]] <- cor2fisher(attr(
  # glmmTMB::VarCorr(nb2modelFull1)[[1]]$"ID",
  #"correlation"
  
}

s



#TBI_3catmild TBI                    0.1658014  0.0451941   3.669 0.000244 ***
#TBI_3catpossible mild TBI           0.0733097  0.0283784   2.583 0.009786 ** 
exp(confint(nb2modelFull2))
# cond.TBI_3catmild TBI                   1.0802826  1.2896620  1.1803387
# cond.TBI_3catpossible mild TBI          1.0178465  1.1376108  1.0760637
 

 


################
###Diagnostics
compare.percent.count <- function(orig,imp,counts){
  nam=names(orig[colSums(is.na(orig))>0])
  nam = nam[nam %in% counts]
  output <- vector(length(nam), mode="list")
  names(output)<-nam
  for (i in 1:length(nam)){
    data <- mice::complete(imp,"long")
    ry= is.na(orig[,nam[i]])
    ry[ry==TRUE]<-"imputed"
    ry[ry==FALSE]<-"observed"
    data <- cbind(data,ry)
    colnames(data)[length(colnames(data))]<-paste0("R.",nam[i])
    tab <- table(data[,nam[i]],data[,paste0("R.",nam[i])])
    
    
    output[[i]]<- rbind("imputed"=round(tab[,1]/sum(tab[,1])*100,2),
                        "observed"=round(tab[,2]/sum(tab[,2])*100,2))
    
  }
  return(output)
}

result <- compare.percent.count(orig=dat2, imp=imp.pmm3, counts= c("household_income"))
result
 
###########

#mediation analyses only includes year 3 data (i.e., second time the ABCD Study did MRI scanning)

######
 
#total cortical area

system.time(model_mediator1 <- bf(smri_area_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome1 <- bf(CBCL_total ~ 1 + smri_area_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result1<- brm(model_mediator1+ model_outcome1 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result1)
bayestestR::mediation(med_result1, treatment="TBI_3catmildTBI")
# smriareacdktotalscaled_TBI_3catmildTBI                               -0.05     0.16    -0.36     0.26 1.00    12761     2838
#smriareacdktotalscaled_TBI_3catpossiblemildTBI                        0.03      0.09    -0.14     0.20 1.00    10383     2829
#CBCLtotal_smri_area_cdk_total_scaled                                 -0.07      0.01    -0.10    -0.04 1.00     7778     3375
# Treatment: TBI_3catmildTBI
# Mediator : smri_area_cdk_total_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.596 | [ 0.235,  0.971]
# Indirect Effect (ACME) |    0.003 | [-0.018,  0.026]
# Mediator Effect        |   -0.068 | [-0.097, -0.040]
# Total Effect           |    0.599 | [ 0.239,  0.976]
# 
# Proportion mediated: 0.52% [-4.03%, 5.08%]

#####

system.time(model_mediator1b <- bf(smri_area_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome1b <- bf(pps_y_ss_severity_score ~ 1 + smri_area_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result1b<- brm(model_mediator1b+ model_outcome1b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result1b)
bayestestR::mediation(med_result1b, treatment="TBI_3catmildTBI")
#smriareacdktotalscaled_TBI_3catmildTBI                               -0.05      0.16    -0.36     0.25 1.00     9224     2813
#smriareacdktotalscaled_TBI_3catpossiblemildTBI                        0.04      0.09    -0.14     0.22 1.00    10031     2803
#ppsyssseverityscore_smri_area_cdk_total_scaled                       -0.09      0.03    -0.16    -0.03 1.00     7184     3359
# Treatment: TBI_3catmildTBI
# Mediator : smri_area_cdk_total_scaled
# Response : ppsyssseverityscore
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.395 | [-0.374,  1.381]
# Indirect Effect (ACME) |    0.004 | [-0.027,  0.036]
# Mediator Effect        |   -0.091 | [-0.154, -0.027]
# Total Effect           |    0.400 | [-0.375,  1.397]
# 
# Proportion mediated: 1.00% [-28.28%, 30.29%]

#####
#total volume

system.time(model_mediator3 <- bf(smri_vol_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome3 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result3<- brm(model_mediator3+ model_outcome3 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result3)
bayestestR::mediation(med_result3, treatment="TBI_3catmildTBI")
#smrivolcdktotalscaled_TBI_3catmildTBI                               -0.15      0.15    -0.45     0.15 1.00     9304     2494
#smrivolcdktotalscaled_TBI_3catpossiblemildTBI                        0.08      0.09    -0.10     0.27 1.00     8577     3019
#ppsyssseverityscore_smri_vol_cdk_total_scaled                       -0.12      0.03    -0.19    -0.06 1.00     7066     3113

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_cdk_total_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.370 | [-0.374,  1.299]
# Indirect Effect (ACME) |    0.018 | [-0.018,  0.063]
# Mediator Effect        |   -0.124 | [-0.189, -0.061]
# Total Effect           |    0.393 | [-0.356,  1.330]
# 
# Proportion mediated: 4.47% [-47.65%, 56.59%]


system.time(model_mediator3b <- bf(smri_vol_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome3b<- bf(CBCL_total ~ 1 + smri_vol_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result3b<- brm(model_mediator3b+ model_outcome3b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result3b)
bayestestR::mediation(med_result3b, treatment="TBI_3catmildTBI")

#smrivolcdktotalscaled_TBI_3catmildTBI                               -0.16      0.15    -0.45     0.14 1.00     9608     2831
#smrivolcdktotalscaled_TBI_3catpossiblemildTBI                        0.08      0.09    -0.10     0.27 1.00     8921     2707
#CBCLtotal_smri_vol_cdk_total_scaled                                 -0.08      0.01    -0.11    -0.05 1.00     8104     3254

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_cdk_total_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.588 | [ 0.223,  1.004]
# Indirect Effect (ACME) |    0.012 | [-0.011,  0.037]
# Mediator Effect        |   -0.078 | [-0.105, -0.048]
# Total Effect           |    0.599 | [ 0.231,  1.016]
# 
# Proportion mediated: 1.95% [-3.13%, 7.03%]


######
#mean cortical thickness
system.time(model_mediator4 <- bf(smri_thick_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome4 <- bf(pps_y_ss_severity_score ~ 1 + smri_thick_cdk_mean_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result4<- brm(model_mediator4+ model_outcome4 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result4)
bayestestR::mediation(med_result4, treatment="TBI_3catmildTBI")

#smrithickcdkmeanscaled_TBI_3catmildTBI                               -0.20      0.16    -0.51     0.13 1.00    10791     2757
#smrithickcdkmeanscaled_TBI_3catpossiblemildTBI                        0.17      0.10    -0.02     0.36 1.00    10219     2812
#ppsyssseverityscore_smri_thick_cdk_mean_scaled                       -0.09      0.03    -0.15    -0.03 1.00     9003     3163

# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.381 | [-0.349,  1.302]
# Indirect Effect (ACME) |    0.015 | [-0.011,  0.052]
# Mediator Effect        |   -0.087 | [-0.148, -0.026]
# Total Effect           |    0.398 | [-0.333,  1.321]
# 
# Proportion mediated: 3.79% [-40.03%, 47.61%]



system.time(model_mediator4b <- bf(smri_thick_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome4b<- bf(CBCL_total ~ 1 + smri_thick_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result4b<- brm(model_mediator4b+ model_outcome4b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result4b)
bayestestR::mediation(med_result4b, treatment="TBI_3catmildTBI")
# smrithickcdkmeanscaled_TBI_3catmildTBI                               -0.20      0.16    -0.51     0.12 1.00     9642     2363
#smrithickcdkmeanscaled_TBI_3catpossiblemildTBI                        0.17      0.10    -0.02     0.37 1.00    10567     2894
#CBCLtotal_smri_thick_cdk_mean_scaled                                 -0.02      0.01    -0.05     0.01 1.00     8779     2800
# Treatment: TBI_3catmildTBI
# Mediator : smri_thick_cdk_mean_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.587 | [ 0.251, 0.962]
# Indirect Effect (ACME) |    0.003 | [-0.003, 0.016]
# Mediator Effect        |   -0.021 | [-0.048, 0.006]
# Total Effect           |    0.592 | [ 0.255, 0.966]
# 
# Proportion mediated: 0.51% [-1.47%, 2.50%]

#######
#mean cortical sulcal depth
system.time(model_mediator5 <- bf(smri_sulc_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome5 <- bf(pps_y_ss_severity_score ~ 1 + smri_sulc_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result5<- brm(model_mediator5+ model_outcome5 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result5)
bayestestR::mediation(med_result5, treatment="TBI_3catmildTBI")
#smrisulccdkmeanscaled_TBI_3catmildTBI                                0.07      0.16    -0.25     0.38 1.00     9784     2719
#smrisulccdkmeanscaled_TBI_3catpossiblemildTBI                       -0.08      0.09    -0.26     0.10 1.00     9616     2772
#ppsyssseverityscore_smri_sulc_cdk_mean_scaled                       -0.05      0.03    -0.11     0.00 1.00     6767     3163

# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.413 | [-0.333, 1.372]
# Indirect Effect (ACME) |   -0.002 | [-0.027, 0.016]
# Mediator Effect        |   -0.052 | [-0.110, 0.005]
# Total Effect           |    0.411 | [-0.339, 1.376]
# 
# Proportion mediated: -0.57% [-18.48%, 17.34%]

system.time(model_mediator5b <- bf(smri_sulc_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome5b<- bf(CBCL_total ~ 1 + smri_sulc_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result5b<- brm(model_mediator5b+ model_outcome5b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result5b)
bayestestR::mediation(med_result5b, treatment="TBI_3catmildTBI")
#smrisulccdkmeanscaled_TBI_3catmildTBI                                0.06      0.16    -0.25     0.38 1.00     8490     2772
#smrisulccdkmeanscaled_TBI_3catpossiblemildTBI                       -0.08      0.10    -0.28     0.12 1.00     9495     3027
#CBCLtotal_smri_sulc_cdk_mean_scaled                                 -0.02      0.01    -0.05     0.01 1.00     8219     2696
# Treatment: TBI_3catmildTBI
# Mediator : smri_sulc_cdk_mean_scaled
# Response : CBCLtotal
# 
#Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.595 | [ 0.255, 0.975]
# Indirect Effect (ACME) | -6.302e-04 | [-0.011, 0.006]
# Mediator Effect        |     -0.018 | [-0.046, 0.009]
# Total Effect           |      0.594 | [ 0.256, 0.975]
# 
# Proportion mediated: -0.11% [-1.72%, 1.50%]

#####
#intracranial volume
system.time(model_mediator6 <- bf(smri_vol_scs_intracranialv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome6 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_intracranialv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result6<- brm(model_mediator6+ model_outcome6 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result6)
bayestestR::mediation(med_result6, treatment="TBI_3catmildTBI")
#smrivolscsintracranialvscaled_TBI_3catmildTBI                               -0.04      0.15    -0.33     0.26 1.01    11071     2256
#smrivolscsintracranialvscaled_TBI_3catpossiblemildTBI                        0.05      0.09    -0.12     0.23 1.00     9474     3080
#ppsyssseverityscore_smri_vol_scs_intracranialv_scaled                       -0.11      0.03    -0.17    -0.05 1.00     6564     3097

# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.408 | [-0.342,  1.333]
# Indirect Effect (ACME) |    0.003 | [-0.033,  0.042]
# Mediator Effect        |   -0.112 | [-0.174, -0.052]
# Total Effect           |    0.412 | [-0.336,  1.339]
# 
# Proportion mediated: 0.84% [-35.04%, 36.72%]



system.time(model_mediator6b <- bf(smri_vol_scs_intracranialv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome6b<- bf(CBCL_total ~ 1 + smri_vol_scs_intracranialv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result6b<- brm(model_mediator6b+ model_outcome6b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result6b)
bayestestR::mediation(med_result6b, treatment="TBI_3catmildTBI")
#smrivolscsintracranialvscaled_TBI_3catmildTBI                               -0.04      0.16    -0.34     0.27 1.00     9472     2772
#smrivolscsintracranialvscaled_TBI_3catpossiblemildTBI                        0.05      0.09    -0.12     0.23 1.00    10339     2972
#CBCLtotal_smri_vol_scs_intracranialv_scaled                                 -0.06      0.01    -0.09    -0.03 1.00     7238     3556
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_intracranialv_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.596 | [ 0.256,  0.991]
# Indirect Effect (ACME) |    0.002 | [-0.017,  0.021]
# Mediator Effect        |   -0.057 | [-0.087, -0.028]
# Total Effect           |    0.599 | [ 0.257,  0.990]
# 
# Proportion mediated: 0.34% [-3.45%, 4.13%]


######
#scgv
system.time(model_mediator7 <- bf(smri_vol_scs_subcorticalgv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome7 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_subcorticalgv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result7<- brm(model_mediator7+ model_outcome7 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result7)
bayestestR::mediation(med_result7, treatment="TBI_3catmildTBI")
#smrivolscssubcorticalgvscaled_TBI_3catmildTBI                               -0.07      0.16    -0.39     0.26 1.00     8940     2817
#smrivolscssubcorticalgvscaled_TBI_3catpossiblemildTBI                        0.08      0.10    -0.11     0.27 1.00     9961     2966
#ppsyssseverityscore_smri_vol_scs_subcorticalgv_scaled                       -0.12      0.03    -0.18    -0.05 1.00     7137     3439

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_subcorticalgv_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.395 | [-0.366,  1.356]
# Indirect Effect (ACME) |    0.007 | [-0.030,  0.050]
# Mediator Effect        |   -0.118 | [-0.181, -0.054]
# Total Effect           |    0.409 | [-0.361,  1.359]
# 
# Proportion mediated: 1.83% [-40.93%, 44.59%]


system.time(model_mediator7b <- bf(smri_vol_scs_subcorticalgv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome7b<- bf(CBCL_total ~ 1 + smri_vol_scs_subcorticalgv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result7b<- brm(model_mediator7b+ model_outcome7b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result7b)
bayestestR::mediation(med_result7b, treatment="TBI_3catmildTBI")
#smrivolscssubcorticalgvscaled_TBI_3catmildTBI                               -0.07      0.16    -0.39     0.25 1.00    11640     3266
#smrivolscssubcorticalgvscaled_TBI_3catpossiblemildTBI                        0.08      0.10    -0.12     0.27 1.00    12021     2710
#CBCLtotal_smri_vol_scs_subcorticalgv_scaled                                 -0.07      0.01    -0.10    -0.04 1.00     7252     3416
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_subcorticalgv_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.584 | [ 0.248,  0.984]
# Indirect Effect (ACME) |    0.005 | [-0.017,  0.029]
# Mediator Effect        |   -0.070 | [-0.097, -0.043]
# Total Effect           |    0.589 | [ 0.252,  0.993]
# 
# Proportion mediated: 0.77% [-3.91%, 5.45%]


#####
#cbwmatterrh

system.time(model_mediator8 <- bf(smri_vol_scs_cbwmatterrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome8 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_cbwmatterrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result8<- brm(model_mediator8+ model_outcome8 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result8)
bayestestR::mediation(med_result8, treatment="TBI_3catmildTBI")
#smrivolscscbwmatterrhscaled_TBI_3catmildTBI                               -0.01      0.17    -0.36     0.32 1.00     9251     2491
#smrivolscscbwmatterrhscaled_TBI_3catpossiblemildTBI                        0.10      0.10    -0.10     0.30 1.00    12176     2862
#ppsyssseverityscore_smri_vol_scs_cbwmatterrh_scaled                       -0.10      0.03    -0.16    -0.04 1.00     6907     3605
# 
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterrh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.403 | [-0.369,  1.391]
# Indirect Effect (ACME) |    0.001 | [-0.035,  0.039]
# Mediator Effect        |   -0.102 | [-0.161, -0.043]
# Total Effect           |    0.404 | [-0.367,  1.395]
# 
# Proportion mediated: 0.35% [-32.95%, 33.66%]

system.time(model_mediator8b <- bf(smri_vol_scs_cbwmatterrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome8b<- bf(CBCL_total ~ 1 + smri_vol_scs_cbwmatterrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result8b<- brm(model_mediator8b+ model_outcome8b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result8b)
bayestestR::mediation(med_result8b, treatment="TBI_3catmildTBI")
# smrivolscscbwmatterrhscaled_TBI_3catmildTBI                               -0.02      0.17    -0.35     0.31 1.00    12154     2439
#smrivolscscbwmatterrhscaled_TBI_3catpossiblemildTBI                        0.10      0.10    -0.09     0.29 1.00    10620     3203
#CBCLtotal_smri_vol_scs_cbwmatterrh_scaled                                 -0.07      0.01    -0.09    -0.04 1.00     7546     3207
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterrh_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.594 | [ 0.236,  0.981]
# Indirect Effect (ACME) |    0.001 | [-0.021,  0.024]
# Mediator Effect        |   -0.065 | [-0.092, -0.037]
# Total Effect           |    0.596 | [ 0.236,  0.980]
# 
# Proportion mediated: 0.19% [-4.35%, 4.74%]


######
#cbwmatterlh
system.time(model_mediator9 <- bf(smri_vol_scs_cbwmatterlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                  +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome9 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_cbwmatterlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result9<- brm(model_mediator9+ model_outcome9 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                  backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result9)
bayestestR::mediation(med_result9, treatment="TBI_3catmildTBI")
#smrivolscscbwmatterlhscaled_TBI_3catmildTBI                               -0.09      0.16    -0.40     0.24 1.00    10640     2903
#smrivolscscbwmatterlhscaled_TBI_3catpossiblemildTBI                        0.10      0.09    -0.08     0.28 1.00     9362     2738
#ppsyssseverityscore_smri_vol_scs_cbwmatterlh_scaled                       -0.10      0.03    -0.16    -0.04 1.00     7451     2995
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.423 | [-0.351,  1.364]
# Indirect Effect (ACME) |    0.008 | [-0.026,  0.045]
# Mediator Effect        |   -0.103 | [-0.163, -0.043]
# Total Effect           |    0.429 | [-0.348,  1.376]
# 
# Proportion mediated: 1.85% [-31.45%, 35.15%]


system.time(model_mediator9b <- bf(smri_vol_scs_cbwmatterlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome9b<- bf(CBCL_total ~ 1 + smri_vol_scs_cbwmatterlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result9b<- brm(model_mediator9b+ model_outcome9b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result9b)
bayestestR::mediation(med_result9b, treatment="TBI_3catmildTBI")
#smrivolscscbwmatterlhscaled_TBI_3catmildTBI                               -0.09      0.17    -0.41     0.24 1.00    10030     2932
#smrivolscscbwmatterlhscaled_TBI_3catpossiblemildTBI                        0.10      0.10    -0.10     0.30 1.00    10997     2597
#CBCLtotal_smri_vol_scs_cbwmatterlh_scaled                                 -0.06      0.01    -0.09    -0.04 1.00     7174     3330

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterlh_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.589 | [ 0.242,  0.989]
# Indirect Effect (ACME) |    0.005 | [-0.016,  0.027]
# Mediator Effect        |   -0.064 | [-0.091, -0.036]
# Total Effect           |    0.594 | [ 0.248,  0.997]
# 
# Proportion mediated: 0.92% [-3.56%, 5.39%]


######

#whole brain volume

system.time(model_mediator11 <- bf(smri_vol_scs_wholeb_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome11 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_wholeb_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result11<- brm(model_mediator11+ model_outcome11 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result11)
bayestestR::mediation(med_result11, treatment="TBI_3catmildTBI")
#smrivolscswholebscaled_TBI_3catmildTBI                               -0.10      0.16    -0.40     0.21 1.00    10099     2604
#smrivolscswholebscaled_TBI_3catpossiblemildTBI                        0.09      0.09    -0.09     0.27 1.00     8191     2673
#ppsyssseverityscore_smri_vol_scs_wholeb_scaled                       -0.13      0.03    -0.19    -0.06 1.00     6892     3262
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_wholeb_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.394 | [-0.349,  1.329]
# Indirect Effect (ACME) |    0.012 | [-0.026,  0.056]
# Mediator Effect        |   -0.128 | [-0.190, -0.065]
# Total Effect           |    0.407 | [-0.341,  1.350]
# 
# Proportion mediated: 2.95% [-42.39%, 48.29%]


system.time(model_mediator11b <- bf(smri_vol_scs_wholeb_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome11b<- bf(CBCL_total ~ 1 + smri_vol_scs_wholeb_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result11b<- brm(model_mediator11b+ model_outcome11b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result11b)
bayestestR::mediation(med_result11b, treatment="TBI_3catmildTBI")
#smrivolscswholebscaled_TBI_3catmildTBI                               -0.10      0.16    -0.41     0.22 1.00     9911     2650
#smrivolscswholebscaled_TBI_3catpossiblemildTBI                        0.09      0.09    -0.10     0.27 1.00     9553     2611
#CBCLtotal_smri_vol_scs_wholeb_scaled                                 -0.08      0.01    -0.11    -0.05 1.00     6508     3143

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_wholeb_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.589 | [ 0.237,  0.988]
# Indirect Effect (ACME) |    0.008 | [-0.018,  0.035]
# Mediator Effect        |   -0.082 | [-0.111, -0.052]
# Total Effect           |    0.595 | [ 0.244,  0.998]
# 
# Proportion mediated: 1.37% [-4.16%, 6.89%]

####
#csf
system.time(model_mediator12a <- bf(smri_vol_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome12a <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_csf_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result12a<- brm(model_mediator12a+ model_outcome12a + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.99),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result12a)
bayestestR::mediation(med_result12a, treatment="TBI_3catmildTBI")
#smrivolscscsfscaled_TBI_3catmildTBI                               -0.52      0.19    -0.89    -0.15 1.00     6357     3193
#smrivolscscsfscaled_TBI_3catpossiblemildTBI                        0.02      0.11    -0.21     0.24 1.00     5890     2706
#ppsyssseverityscore_smri_vol_scs_csf_scaled                       -0.04      0.02    -0.09     0.01 1.00     6250     2748
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_csf_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.403 | [-0.345, 1.379]
# Indirect Effect (ACME) |    0.020 | [-0.003, 0.056]
# Mediator Effect        |   -0.043 | [-0.086, 0.007]
# Total Effect           |    0.425 | [-0.327, 1.399]
# 
# Proportion mediated: 4.64% [-48.96%, 58.23%]



system.time(model_mediator12b <- bf(smri_vol_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome12b<- bf(CBCL_total ~ 1 + smri_vol_scs_csf_scaled+ TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result12b<- brm(model_mediator12b+ model_outcome12b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.99),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result12b)
bayestestR::mediation(med_result12b, treatment="TBI_3catmildTBI")
#smrivolscscsfscaled_TBI_3catmildTBI                               -0.51      0.20    -0.91    -0.11 1.00     6288     2920
#smrivolscscsfscaled_TBI_3catpossiblemildTBI                        0.02      0.11    -0.21     0.24 1.00     7123     2919
#CBCLtotal_smri_vol_scs_csf_scaled                                 -0.01      0.01    -0.04     0.01 1.00     6283     2965
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_csf_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.582 | [ 0.234, 0.971]
# Indirect Effect (ACME) |    0.006 | [-0.005, 0.023]
# Mediator Effect        |   -0.013 | [-0.035, 0.009]
# Total Effect           |    0.587 | [ 0.242, 0.977]
# 
# Proportion mediated: 1.02% [-1.91%, 3.95%]


########

#all ventricle volume
system.time(model_mediator13 <- bf(smri_vol_scs_allventricles_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome13 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_allventricles_scaled+ TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result13<- brm(model_mediator13+ model_outcome13 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))

summary(med_result13)
# smrivolscsallventriclesscaled_TBI_3catmildTBI                               -0.27      0.19    -0.64     0.12 1.00     9096     2602
# smrivolscsallventriclesscaled_TBI_3catpossiblemildTBI                       -0.03      0.12    -0.25     0.20 1.00    11437     2657
# ppsyssseverityscore_smri_vol_scs_allventricles_scaled                        0.01      0.03    -0.04     0.06 1.00     8438     2853


bayestestR::mediation(med_result13, treatment="TBI_3catmildTBI")
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_allventricles_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.432 | [-0.321, 1.362]
# Indirect Effect (ACME) |   -0.002 | [-0.024, 0.013]
# Mediator Effect        |    0.012 | [-0.039, 0.063]
# Total Effect           |    0.430 | [-0.323, 1.356]
# 
# Proportion mediated: -0.41% [-14.41%, 13.58%]



system.time(model_mediator13b <- bf(smri_vol_scs_allventricles_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome13b<- bf(CBCL_total ~ 1 + smri_vol_scs_allventricles_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result13b<- brm(model_mediator13b+ model_outcome13b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result13b)
bayestestR::mediation(med_result13b, treatment="TBI_3catmildTBI")
#smrivolscsallventriclesscaled_TBI_3catmildTBI                               -0.27      0.19    -0.65     0.11 1.00     8466     2740
#smrivolscsallventriclesscaled_TBI_3catpossiblemildTBI                       -0.03      0.11    -0.25     0.19 1.01    11629     2779
#CBCLtotal_smri_vol_scs_allventricles_scaled                                  0.00      0.01    -0.02     0.03 1.00     7619     2973

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_allventricles_scaled
# Response : CBCLtotal
# 
#Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.592 | [ 0.242, 0.982]
# Indirect Effect (ACME) | -3.988e-05 | [-0.009, 0.008]
# Mediator Effect        |  7.092e-04 | [-0.023, 0.025]
# Total Effect           |      0.592 | [ 0.242, 0.980]
# 
# Proportion mediated: -6.73e-03% [-1.76%, 1.75%]



####

#####
#ltventriclelh
system.time(model_mediator14 <- bf(smri_vol_scs_ltventriclelh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome14<- bf(CBCL_total ~ 1 + smri_vol_scs_ltventriclelh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result14<- brm(model_mediator14+ model_outcome14 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result14)
bayestestR::mediation(med_result14, treatment="TBI_3catmildTBI")
#smrivolscsltventriclelhscaled_TBI_3catmildTBI                               -0.31      0.20    -0.71     0.08 1.00     9290     2913
#smrivolscsltventriclelhscaled_TBI_3catpossiblemildTBI                       -0.01      0.12    -0.24     0.21 1.00     9759     2611
#CBCLtotal_smri_vol_scs_ltventriclelh_scaled                                  0.00      0.01    -0.02     0.03 1.00    10009     2951
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclelh_scaled
# Response : CBCLtotal
# 
#Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.592 | [ 0.243, 0.969]
# Indirect Effect (ACME) | -8.431e-04 | [-0.012, 0.007]
# Mediator Effect        |      0.005 | [-0.019, 0.029]
# Total Effect           |      0.590 | [ 0.241, 0.965]
# 
# Proportion mediated: -0.14% [-2.15%, 1.86%]


system.time(model_mediator14b <- bf(smri_vol_scs_ltventriclelh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome14b <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_ltventriclelh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result14b<- brm(model_mediator14b+ model_outcome14b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result14b)
bayestestR::mediation(med_result14b, treatment="TBI_3catmildTBI")
#smrivolscsltventriclelhscaled_TBI_3catmildTBI                               -0.32      0.20    -0.70     0.07 1.00    11102     2451
#smrivolscsltventriclelhscaled_TBI_3catpossiblemildTBI                       -0.01      0.12    -0.25     0.23 1.00    11931     2737
#ppsyssseverityscore_smri_vol_scs_ltventriclelh_scaled                        0.01      0.03    -0.04     0.07 1.00    11073     2954
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclelh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.423 | [-0.330, 1.348]
# Indirect Effect (ACME) |   -0.003 | [-0.029, 0.013]
# Mediator Effect        |    0.013 | [-0.036, 0.066]
# Total Effect           |    0.416 | [-0.331, 1.341]
# 
# Proportion mediated: -0.65% [-20.70%, 19.40%]

####


######
#ltventriclerh

system.time(model_mediator15 <- bf(smri_vol_scs_ltventriclerh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome15 <- bf(pps_y_ss_severity_score ~1 + smri_vol_scs_ltventriclerh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result15<- brm(model_mediator15+ model_outcome15 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result15)
bayestestR::mediation(med_result15, treatment="TBI_3catmildTBI")
#smrivolscsltventriclerhscaled_TBI_3catmildTBI                               -0.16      0.19    -0.54     0.23 1.00     9274     3137
#smrivolscsltventriclerhscaled_TBI_3catpossiblemildTBI                       -0.03      0.12    -0.26     0.20 1.00    10125     2970
#ppsyssseverityscore_smri_vol_scs_ltventriclerh_scaled                        0.01      0.03    -0.04     0.06 1.00     8786     3188
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclerh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.413 | [-0.316, 1.352]
# Indirect Effect (ACME) | -7.602e-04 | [-0.019, 0.011]
# Mediator Effect        |      0.013 | [-0.037, 0.065]
# Total Effect           |      0.412 | [-0.318, 1.354]
# 
# Proportion mediated: -0.18% [-11.87%, 11.50%]



system.time(model_mediator15b <- bf(smri_vol_scs_ltventriclerh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome15b<- bf(CBCL_total ~1 + smri_vol_scs_ltventriclerh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result15b<- brm(model_mediator15b+ model_outcome15b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result15b)
bayestestR::mediation(med_result15b, treatment="TBI_3catmildTBI")
#smrivolscsltventriclerhscaled_TBI_3catmildTBI                               -0.16      0.19    -0.53     0.22 1.00    10192     2753
#smrivolscsltventriclerhscaled_TBI_3catpossiblemildTBI                       -0.03      0.11    -0.25     0.19 1.00     8282     2894
#CBCLtotal_smri_vol_scs_ltventriclerh_scaled                                  0.00      0.01    -0.02     0.02 1.00     9661     3211
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclerh_scaled
# Response : CBCLtotal
# 
# Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.592 | [ 0.245, 0.997]
# Indirect Effect (ACME) | -2.924e-05 | [-0.006, 0.006]
# Mediator Effect        |  6.822e-04 | [-0.023, 0.024]
# Total Effect           |      0.592 | [ 0.247, 0.997]
# 
# Proportion mediated: -4.94e-03% [-1.22%, 1.21%]

#####

#3rd ventricle
system.time(model_mediator16 <- bf(smri_vol_scs_3rdventricle_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome16 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_3rdventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result16<- brm(model_mediator16+ model_outcome16 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result16)
#smrivolscs3rdventriclescaled_TBI_3catmildTBI                               -0.35      0.19    -0.73     0.02 1.00    10650     2724
#smrivolscs3rdventriclescaled_TBI_3catpossiblemildTBI                        0.03      0.11    -0.20     0.25 1.00    10583     2952
#ppsyssseverityscore_smri_vol_scs_3rdventricle_scaled                       -0.01      0.03    -0.06     0.04 1.00     8207     3266
bayestestR::mediation(med_result16, treatment="TBI_3catmildTBI")
# 
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_3rdventricle_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.399 | [-0.350, 1.373]
# Indirect Effect (ACME) |    0.003 | [-0.016, 0.029]
# Mediator Effect        |   -0.012 | [-0.063, 0.039]
# Total Effect           |    0.403 | [-0.353, 1.376]
# 
# Proportion mediated: 0.71% [-18.87%, 20.28%]

#####
 
system.time(model_mediator16b <- bf(smri_vol_scs_3rdventricle_scaled ~  1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome16b<- bf(CBCL_total ~ 1 + smri_vol_scs_3rdventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result16b<- brm(model_mediator16b+ model_outcome16b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result16b)
bayestestR::mediation(med_result16b, treatment="TBI_3catmildTBI")
#smrivolscs3rdventriclescaled_TBI_3catmildTBI                               -0.36      0.19    -0.72     0.01 1.00    10061     2906
#smrivolscs3rdventriclescaled_TBI_3catpossiblemildTBI                        0.03      0.11    -0.20     0.25 1.00     8322     2395
#CBCLtotal_smri_vol_scs_3rdventricle_scaled                                 -0.01      0.01    -0.04     0.01 1.00    10334     3008
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_3rdventricle_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.592 | [ 0.228, 0.980]
# Indirect Effect (ACME) |    0.003 | [-0.005, 0.017]
# Mediator Effect        |   -0.012 | [-0.036, 0.014]
# Total Effect           |    0.597 | [ 0.234, 0.983]

#Proportion mediated: 0.56% [-1.81%, 2.93%]

########
#4thventricle
system.time(model_mediator17 <- bf(smri_vol_scs_4thventricle_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome17 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_4thventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result17<- brm(model_mediator17+ model_outcome17 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result17)
bayestestR::mediation(med_result17, treatment="TBI_3catmildTBI")
# smrivolscs4thventriclescaled_TBI_3catmildTBI                               -0.28      0.19    -0.65     0.08 1.00    10128     2891
# smrivolscs4thventriclescaled_TBI_3catpossiblemildTBI                       -0.04      0.11    -0.25     0.17 1.00    11862     3236
# ppsyssseverityscore_smri_vol_scs_4thventricle_scaled                       -0.03      0.03    -0.08     0.02 1.00     9701     3396
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_4thventricle_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.430 | [-0.334, 1.396]
# Indirect Effect (ACME) |    0.006 | [-0.008, 0.034]
# Mediator Effect        |   -0.028 | [-0.082, 0.023]
# Total Effect           |    0.439 | [-0.327, 1.410]
# 
# Proportion mediated: 1.35% [-17.96%, 20.66%]



system.time(model_mediator17b <- bf(smri_vol_scs_4thventricle_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome17b<- bf(CBCL_total ~ 1 + smri_vol_scs_4thventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result17b<- brm(model_mediator17b+ model_outcome17b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result17b)
bayestestR::mediation(med_result17b, treatment="TBI_3catmildTBI")
#smrivolscs4thventriclescaled_TBI_3catmildTBI                               -0.28      0.19    -0.65     0.10 1.00     9171     2059
#smrivolscs4thventriclescaled_TBI_3catpossiblemildTBI                       -0.04      0.11    -0.26     0.18 1.00     9653     2473
#CBCLtotal_smri_vol_scs_4thventricle_scaled                                 -0.02      0.01    -0.04     0.00 1.00     9275     3125
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_4thventricle_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.582 | [ 0.224, 0.972]
# Indirect Effect (ACME) |    0.004 | [-0.003, 0.019]
# Mediator Effect        |   -0.019 | [-0.044, 0.004]
# Total Effect           |    0.586 | [ 0.234, 0.976]
# 
# Proportion mediated: 0.76% [-1.68%, 3.19%]

####
#inflatventlh
system.time(model_mediator18 <- bf(smri_vol_scs_inflatventlh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome18 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_inflatventlh.x_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result18<- brm(model_mediator18+ model_outcome18 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result18)
bayestestR::mediation(med_result18, treatment="TBI_3catmildTBI")
#smrivolscsinflatventlhxscaled_TBI_3catmildTBI                               -0.07      0.18    -0.42     0.29 1.00     9158     2079
#smrivolscsinflatventlhxscaled_TBI_3catpossiblemildTBI                       -0.08      0.11    -0.28     0.14 1.00     8564     2732
#ppsyssseverityscore_smri_vol_scs_inflatventlh.x_scaled                       0.01      0.03    -0.05     0.06 1.00     9867     3267
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_inflatventlh.x_scaled
# Response : ppsyssseverityscore
# 
#Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.410 | [-0.329, 1.395]
# Indirect Effect (ACME) | -9.362e-05 | [-0.014, 0.010]
# Mediator Effect        |      0.005 | [-0.047, 0.061]
# Total Effect           |      0.410 | [-0.327, 1.395]
# 
# Proportion mediated: -0.02% [-8.66%, 8.62%]


system.time(model_mediator18b <- bf(smri_vol_scs_inflatventlh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome18b<- bf(CBCL_total ~ 1 + smri_vol_scs_inflatventlh.x_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result18b<- brm(model_mediator18b+ model_outcome18b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result18b)
bayestestR::mediation(med_result18b, treatment="TBI_3catmildTBI")
# smrivolscsinflatventlhxscaled_TBI_3catmildTBI                               -0.07      0.19    -0.44     0.30 1.00    10403     2939
#smrivolscsinflatventlhxscaled_TBI_3catpossiblemildTBI                       -0.08      0.11    -0.29     0.14 1.00     8531     3034
#CBCLtotal_smri_vol_scs_inflatventlh.x_scaled                                -0.01      0.01    -0.04     0.02 1.00     8127     2543
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_inflatventlh.x_scaled
# Response : CBCLtotal
# 
# Effect                 |  Estimate |         95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |     0.593 | [ 0.240, 0.980]
# Indirect Effect (ACME) | 1.979e-04 | [-0.006, 0.008]
# Mediator Effect        |    -0.010 | [-0.035, 0.016]
# Total Effect           |     0.594 | [ 0.239, 0.983]
# 
# Proportion mediated: 0.03% [-1.29%, 1.36%]

######

system.time(model_mediator19 <- bf(smri_vol_scs_inflatventrh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome19 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_inflatventrh.x_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result19<- brm(model_mediator19+ model_outcome19 + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result19)
bayestestR::mediation(med_result19, treatment="TBI_3catmildTBI")
# smrivolscsinflatventrhxscaled_TBI_3catmildTBI                                0.09      0.17    -0.24     0.42 1.00    10008     2817
# smrivolscsinflatventrhxscaled_TBI_3catpossiblemildTBI                       -0.11      0.10    -0.31     0.09 1.00     8151     2773
#ppsyssseverityscore_smri_vol_scs_inflatventrh.x_scaled                       0.01      0.03    -0.05     0.06 1.00     8782     3196

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_inflatventrh.x_scaled
# Response : ppsyssseverityscore
# 
# Effect                 |  Estimate |         95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |     0.409 | [-0.350, 1.370]
# Indirect Effect (ACME) | 1.064e-04 | [-0.011, 0.013]
# Mediator Effect        |     0.007 | [-0.050, 0.064]
# Total Effect           |     0.411 | [-0.351, 1.372]
# 
# Proportion mediated: 0.03% [-8.39%, 8.45%]


system.time(model_mediator19b <- bf(smri_vol_scs_inflatventrh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome19b<- bf(CBCL_total ~ 1 + smri_vol_scs_inflatventrh.x_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
system.time(med_result19b<- brm(model_mediator19b+ model_outcome19b + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                                backend="cmdstanr", warmup = 1000, threads = threading(8)))

summary(med_result19b)
bayestestR::mediation(med_result19b, treatment="TBI_3catmildTBI")
# smrivolscsinflatventrhxscaled_TBI_3catmildTBI                                0.09      0.17    -0.25     0.44 1.00     9440     2410
#smrivolscsinflatventrhxscaled_TBI_3catpossiblemildTBI                       -0.11      0.10    -0.30     0.09 1.00     9815     2560
#CBCLtotal_smri_vol_scs_inflatventrh.x_scaled                                 0.02      0.01    -0.01     0.04 1.00     9342     2670

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_inflatventrh.x_scaled
# Response : CBCLtotal
# 
# Effect                 |  Estimate |         95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |     0.585 | [ 0.235, 0.956]
# Indirect Effect (ACME) | 9.377e-04 | [-0.006, 0.011]
# Mediator Effect        |     0.018 | [-0.008, 0.044]
# Total Effect           |     0.587 | [ 0.238, 0.958]
# 
# Proportion mediated: 0.16% [-1.57%, 1.89%]

######
#dlprefrlh


system.time(model_mediator23 <- bf(smri_t1wcnt_cf12_dlprefrlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome23<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf12_dlprefrlh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result23<- brm(model_mediator23+ model_outcome23 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.99),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result23)
bayestestR::mediation(med_result23, treatment="TBI_3catmildTBI")
#smrit1wcntcf12dlprefrlhscaled_TBI_3catmildTBI                               -0.21      0.11    -0.43     0.01 1.00     8018     3064
#smrit1wcntcf12dlprefrlhscaled_TBI_3catpossiblemildTBI                        0.01      0.07    -0.12     0.14 1.00     6957     2932
#CBCLtotal_smri_t1wcnt_cf12_dlprefrlh_scaled                                 -0.06      0.02    -0.09    -0.02 1.00     4312     3385
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf12_dlprefrlh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |  0.580 | [ 0.230,  0.971]
# Indirect Effect (ACME) |    0.011 | [-0.001,  0.030]
# Mediator Effect        |   -0.056 | [-0.091, -0.023]
# Total Effect           |    0.593 | [ 0.241,  0.984]
# 
# Proportion mediated: 1.86% [-1.68%, 5.39%]



system.time(model_mediator23b <- bf(smri_t1wcnt_cf12_dlprefrlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome23b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf12_dlprefrlh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result23b<- brm(model_mediator23b+ model_outcome23b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.99),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result23b)
bayestestR::mediation(med_result23b, treatment="TBI_3catmildTBI")
#smrit1wcntcf12dlprefrlhscaled_TBI_3catmildTBI                               -0.21      0.12    -0.43     0.02 1.00     6942     2769
#smrit1wcntcf12dlprefrlhscaled_TBI_3catpossiblemildTBI                        0.01      0.07    -0.12     0.15 1.00     8219     2863
#ppsyssseverityscore_smri_t1wcnt_cf12_dlprefrlh_scaled                       -0.10      0.04    -0.18    -0.01 1.00     3040     2857
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf12_dlprefrlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.379 | [-0.375,  1.331]
# Indirect Effect (ACME) |    0.018 | [-0.003,  0.057]
# Mediator Effect        |   -0.095 | [-0.184, -0.013]
# Total Effect           |    0.400 | [-0.362,  1.353]
# 
# Proportion mediated: 4.45% [-45.11%, 54.01%]

#####

#frlh
system.time(model_mediator24 <- bf(smri_t1wcnt_cf2_frlh_scaled ~1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome24<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_frlh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result24<- brm(model_mediator24+ model_outcome24 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result24)
bayestestR::mediation(med_result24, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frlhscaled_TBI_3catmildTBI                               -0.16      0.11    -0.38     0.05 1.00     6356     2765
#smrit1wcntcf2frlhscaled_TBI_3catpossiblemildTBI                        0.02      0.06    -0.10     0.14 1.00     6133     2937
#CBCLtotal_smri_t1wcnt_cf2_frlh_scaled                                 -0.05      0.02    -0.09    -0.02 1.00     3623     3498

# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_frlh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.573 | [ 0.231,  0.969]
# Indirect Effect (ACME) |    0.008 | [-0.003,  0.023]
# Mediator Effect        |   -0.052 | [-0.087, -0.018]
# Total Effect           |    0.582 | [ 0.239,  0.979]
# 
# Proportion mediated: 1.29% [-1.61%, 4.20%]

system.time(model_mediator24b <- bf(smri_t1wcnt_cf2_frlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome24b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_frlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result24b<- brm(model_mediator24b+ model_outcome24b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result24b)
bayestestR::mediation(med_result24b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frlhscaled_TBI_3catmildTBI                               -0.16      0.11    -0.37     0.06 1.00     5417     2888
#smrit1wcntcf2frlhscaled_TBI_3catpossiblemildTBI                        0.02      0.06    -0.10     0.14 1.00     5221     2996
#ppsyssseverityscore_smri_t1wcnt_cf2_frlh_scaled                       -0.09      0.04    -0.18    -0.00 1.00     3026     3030
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_frlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.395 | [-0.365,  1.425]
# Indirect Effect (ACME) |    0.011 | [-0.005,  0.045]
# Mediator Effect        |   -0.085 | [-0.178, -0.002]
# Total Effect           |    0.411 | [-0.353,  1.440]
# 
# Proportion mediated: 2.78% [-34.23%, 39.78%]

######
#frrh
system.time(model_mediator25 <- bf(smri_t1wcnt_cf2_frrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome25<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_frrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result25<- brm(model_mediator25+ model_outcome25 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result25)
bayestestR::mediation(med_result25, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frrhscaled_TBI_3catmildTBI                               -0.16      0.11    -0.36     0.06 1.00     6542     2845
#smrit1wcntcf2frrhscaled_TBI_3catpossiblemildTBI                       -0.01      0.06    -0.13     0.12 1.00     6246     3073
#CBCLtotal_smri_t1wcnt_cf2_frrh_scaled                                 -0.06      0.02    -0.09    -0.02 1.00     4039     3083
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.575 | [ 0.230,  0.967]
# Indirect Effect (ACME) |    0.008 | [-0.003,  0.024]
# Mediator Effect        |   -0.056 | [-0.093, -0.021]
# Total Effect           |    0.585 | [ 0.237,  0.973]
# 
# Proportion mediated: 1.38% [-1.62%, 4.37%]
#####

system.time(model_mediator25b <- bf(smri_t1wcnt_cf2_frrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome25b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_frrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result25b<- brm(model_mediator25b+ model_outcome25b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result25b)
bayestestR::mediation(med_result25b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frrhscaled_TBI_3catmildTBI                               -0.15      0.11    -0.36     0.06 1.00     7418     2834
#smrit1wcntcf2frrhscaled_TBI_3catpossiblemildTBI                       -0.01      0.06    -0.13     0.12 1.00     5658     2397
#ppsyssseverityscore_smri_t1wcnt_cf2_frrh_scaled                       -0.09      0.04    -0.18    -0.00 1.00     3307     2972
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_frrh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.392 | [-0.370,  1.394]
# Indirect Effect (ACME) |    0.011 | [-0.005,  0.043]
# Mediator Effect        |   -0.086 | [-0.177, -0.002]
# Total Effect           |    0.405 | [-0.353,  1.407]
# 
# Proportion mediated: 2.77% [-31.85%, 37.39%]

######
system.time(model_mediator26 <- bf(smri_t1wcnt_cf2_ptrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome26<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_ptrh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result26<- brm(model_mediator26+ model_outcome26 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result26)
bayestestR::mediation(med_result26, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptrhscaled_TBI_3catmildTBI                               -0.15      0.10    -0.35     0.05 1.00     7932     3164
#smrit1wcntcf2ptrhscaled_TBI_3catpossiblemildTBI                        0.02      0.06    -0.10     0.14 1.00     7871     2830
#CBCLtotal_smri_t1wcnt_cf2_ptrh_scaled                                 -0.06      0.02    -0.09    -0.02 1.00     3817     3483
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_ptrh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.585 | [ 0.208,  0.998]
# Indirect Effect (ACME) |    0.008 | [-0.003,  0.024]
# Mediator Effect        |   -0.057 | [-0.094, -0.023]
# Total Effect           |    0.592 | [ 0.216,  1.004]
# 
# Proportion mediated: 1.32% [-1.75%, 4.40%]

system.time(model_mediator26b <- bf(smri_t1wcnt_cf2_ptrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome26b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_ptrh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result26b<- brm(model_mediator26b+ model_outcome26b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result26b)
bayestestR::mediation(med_result26b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptrhscaled_TBI_3catmildTBI                               -0.15      0.10    -0.35     0.06 1.00     7329     3072
#smrit1wcntcf2ptrhscaled_TBI_3catpossiblemildTBI                        0.02      0.06    -0.10     0.14 1.00     6158     3110
#ppsyssseverityscore_smri_t1wcnt_cf2_ptrh_scaled                       -0.08      0.04    -0.16     0.01 1.00     2829     3337
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.399 | [-0.371, 1.413]
# Indirect Effect (ACME) |    0.009 | [-0.005, 0.037]
# Mediator Effect        |   -0.076 | [-0.162, 0.008]
# Total Effect           |    0.409 | [-0.357, 1.424]
# 
# Proportion mediated: 2.18% [-28.19%, 32.55%]

#######


system.time(model_mediator27 <- bf(smri_t1wcnt_cf2_ptlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome27<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_ptlh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result27<- brm(model_mediator27+ model_outcome27 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result27)
bayestestR::mediation(med_result27, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptlhscaled_TBI_3catmildTBI                               -0.17      0.11    -0.39     0.04 1.00     8066     2875
#smrit1wcntcf2ptlhscaled_TBI_3catpossiblemildTBI                        0.03      0.07    -0.09     0.16 1.00     7006     2739
#CBCLtotal_smri_t1wcnt_cf2_ptlh_scaled                                 -0.06      0.02    -0.09    -0.02 1.00     4214     3301
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_ptlh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.572 | [ 0.212,  0.967]
# Indirect Effect (ACME) |    0.009 | [-0.002,  0.025]
# Mediator Effect        |   -0.057 | [-0.093, -0.023]
# Total Effect           |    0.583 | [ 0.223,  0.979]
# 
# Proportion mediated: 1.57% [-1.72%, 4.86%]

########

system.time(model_mediator27b <- bf(smri_t1wcnt_cf2_ptlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome27b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_ptlh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result27b<- brm(model_mediator27b+ model_outcome27b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result27b)
bayestestR::mediation(med_result27b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptlhscaled_TBI_3catmildTBI                               -0.17      0.11    -0.39     0.04 1.00     6477     3026
#smrit1wcntcf2ptlhscaled_TBI_3catpossiblemildTBI                        0.04      0.07    -0.09     0.16 1.00     6420     3248
#ppsyssseverityscore_smri_t1wcnt_cf2_ptlh_scaled                       -0.07      0.04    -0.16     0.01 1.00     2812     3113
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_ptlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.378 | [-0.384, 1.372]
# Indirect Effect (ACME) |    0.010 | [-0.005, 0.039]
# Mediator Effect        |   -0.069 | [-0.157, 0.014]
# Total Effect           |    0.392 | [-0.370, 1.383]
# 
# Proportion mediated: 2.51% [-27.15%, 32.17%]

system.time(model_mediator28 <- bf(smri_t1wcnt_cf12_dlprefrrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome28<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf12_dlprefrrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result28<- brm(model_mediator28+ model_outcome28 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result28)
bayestestR::mediation(med_result28, treatment="TBI_3catmildTBI")
# smrit1wcntcf12dlprefrrhscaled_TBI_3catmildTBI                               -0.15      0.12    -0.38     0.09 1.00     7357     2895
# smrit1wcntcf12dlprefrrhscaled_TBI_3catpossiblemildTBI                       -0.02      0.07    -0.16     0.12 1.00     7523     2933
#CBCLtotal_smri_t1wcnt_cf12_dlprefrrh_scaled                                 -0.06      0.02    -0.09    -0.03 1.00     4532     3250
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf12_dlprefrrh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.583 | [ 0.229,  0.983]
# Indirect Effect (ACME) |    0.009 | [-0.005,  0.027]
# Mediator Effect        |   -0.061 | [-0.093, -0.029]
# Total Effect           |    0.591 | [ 0.238,  0.988]
# 
# Proportion mediated: 1.48% [-2.05%, 5.00%]

#####

system.time(model_mediator28b <- bf(smri_t1wcnt_cf12_dlprefrrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome28b <- bf(pps_y_ss_severity_score ~  1 + smri_t1wcnt_cf12_dlprefrrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result28b<- brm(model_mediator28b+ model_outcome28b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result28b)
bayestestR::mediation(med_result28b, treatment="TBI_3catmildTBI")
# smrit1wcntcf12dlprefrrhscaled_TBI_3catmildTBI                               -0.15      0.12    -0.40     0.09 1.00     6068     2908
#smrit1wcntcf12dlprefrrhscaled_TBI_3catpossiblemildTBI                       -0.02      0.07    -0.16     0.12 1.00     6954     2903
#ppsyssseverityscore_smri_t1wcnt_cf12_dlprefrrh_scaled                       -0.11      0.04    -0.19    -0.03 1.00     4143     3237
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.379 | [-0.372,  1.323]
# Indirect Effect (ACME) |    0.015 | [-0.009,  0.052]
# Mediator Effect        |   -0.109 | [-0.191, -0.030]
# Total Effect           |    0.393 | [-0.362,  1.342]
# 
# Proportion mediated: 3.71% [-38.46%, 45.89%]

######


system.time(model_mediator29 <- bf(smri_t1wcnt_cdk_meanlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome29<- bf(CBCL_total ~ 1 + smri_t1wcnt_cdk_meanlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result29<- brm(model_mediator29+ model_outcome29 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result29)
#smrit1wcntcdkmeanlhscaled_TBI_3catmildTBI                               -0.19      0.11    -0.41     0.03 1.00     7298     2780
#smrit1wcntcdkmeanlhscaled_TBI_3catpossiblemildTBI                        0.04      0.07    -0.09     0.16 1.00     7145     2852
#CBCLtotal_smri_t1wcnt_cdk_meanlh_scaled                                 -0.06      0.02    -0.09    -0.02 1.00     3980     3616
bayestestR::mediation(med_result29, treatment="TBI_3catmildTBI")
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanlh_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.576 | [ 0.230,  0.959]
# Indirect Effect (ACME) |    0.010 | [-0.002,  0.027]
# Mediator Effect        |   -0.056 | [-0.092, -0.024]
# Total Effect           |    0.587 | [ 0.242,  0.973]
# 
# Proportion mediated: 1.68% [-1.46%, 4.83%]


system.time(model_mediator29b <- bf(smri_t1wcnt_cdk_meanlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome29b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cdk_meanlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result29b<- brm(model_mediator29b+ model_outcome29b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result29b)
bayestestR::mediation(med_result29b, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanlhscaled_TBI_3catmildTBI                               -0.19      0.12    -0.41     0.04 1.00     7974     2707
#smrit1wcntcdkmeanlhscaled_TBI_3catpossiblemildTBI                        0.04      0.07    -0.09     0.16 1.00     7927     2648
#ppsyssseverityscore_smri_t1wcnt_cdk_meanlh_scaled                       -0.09      0.04    -0.17    -0.00 1.00     2826     3051
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.386 | [-0.390,  1.361]
# Indirect Effect (ACME) |    0.014 | [-0.004,  0.047]
# Mediator Effect        |   -0.086 | [-0.169, -0.005]
# Total Effect           |    0.399 | [-0.368,  1.382]
# 
# Proportion mediated: 3.52% [-39.01%, 46.04%]


######

system.time(model_mediator30 <- bf(smri_t1wcnt_cdk_meanrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome30<- bf(CBCL_total ~ 1 + smri_t1wcnt_cdk_meanrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result30<- brm(model_mediator30+ model_outcome30 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result30)
bayestestR::mediation(med_result30, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanrhscaled_TBI_3catmildTBI                               -0.16      0.11    -0.37     0.05 1.00     7018     2902
#smrit1wcntcdkmeanrhscaled_TBI_3catpossiblemildTBI                        0.01      0.06    -0.11     0.13 1.00     8044     2431
#CBCLtotal_smri_t1wcnt_cdk_meanrh_scaled                                 -0.06      0.02    -0.10    -0.03 1.00     3739     3273
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanrh_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.574 | [ 0.222,  0.968]
# Indirect Effect (ACME) |    0.009 | [-0.003,  0.026]
# Mediator Effect        |   -0.059 | [-0.095, -0.025]
# Total Effect           |    0.583 | [ 0.232,  0.978]
# 
# Proportion mediated: 1.48% [-1.69%, 4.65%]



system.time(model_mediator30b <- bf(smri_t1wcnt_cdk_meanrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome30b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cdk_meanrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result30b<- brm(model_mediator30b+ model_outcome30b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result30b)
bayestestR::mediation(med_result30b, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanrhscaled_TBI_3catmildTBI                               -0.16      0.10    -0.36     0.05 1.00     5832     3126
#smrit1wcntcdkmeanrhscaled_TBI_3catpossiblemildTBI                        0.01      0.06    -0.12     0.13 1.00     6058     2379
#ppsyssseverityscore_smri_t1wcnt_cdk_meanrh_scaled                       -0.09      0.04    -0.18    -0.01 1.00     2726     2936

# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanrh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.391 | [-0.361,  1.361]
# Indirect Effect (ACME) |    0.012 | [-0.005,  0.045]
# Mediator Effect        |   -0.090 | [-0.182, -0.006]
# Total Effect           |    0.404 | [-0.350,  1.378]
# 
# Proportion mediated: 3.04% [-34.94%, 41.02%]

#######

system.time(model_mediator31 <- bf(smri_t1wcnt_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome31<- bf(CBCL_total ~ 1 + smri_t1wcnt_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result31<- brm(model_mediator31+ model_outcome31 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result31)
bayestestR::mediation(med_result31, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanscaled_TBI_3catmildTBI                               -0.17      0.11    -0.39     0.04 1.00     6093     2518
#smrit1wcntcdkmeanscaled_TBI_3catpossiblemildTBI                        0.02      0.06    -0.10     0.14 1.00     6817     2719
#CBCLtotal_smri_t1wcnt_cdk_mean_scaled                                 -0.06      0.02    -0.09    -0.02 1.00     3645     3330

# 
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_mean_scaled
# Response : CBCLtotal
# 
#ffect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.579 | [ 0.213,  0.996]
# Indirect Effect (ACME) |    0.009 | [-0.002,  0.027]
# Mediator Effect        |   -0.058 | [-0.092, -0.025]
# Total Effect           |    0.589 | [ 0.224,  1.006]
# 
# Proportion mediated: 1.54% [-1.83%, 4.92%]


system.time(model_mediator31b <- bf(smri_t1wcnt_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome31b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result31b<- brm(model_mediator31b+ model_outcome31b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result31b)
bayestestR::mediation(med_result31b, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanscaled_TBI_3catmildTBI                               -0.17      0.10    -0.38     0.03 1.00     6028     3159
#smrit1wcntcdkmeanscaled_TBI_3catpossiblemildTBI                        0.02      0.06    -0.10     0.14 1.00     7347     3185
#ppsyssseverityscore_smri_t1wcnt_cdk_mean_scaled                       -0.09      0.04    -0.18    -0.01 1.00     2713     2946
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_mean_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.395 | [-0.344,  1.335]
# Indirect Effect (ACME) |    0.014 | [-0.003,  0.046]
# Mediator Effect        |   -0.089 | [-0.177, -0.007]
# Total Effect           |    0.412 | [-0.328,  1.355]
# 
# Proportion mediated: 3.32% [-33.57%, 40.20%]

#####

system.time(model_mediator32 <- bf(smri_t1w_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome32<- bf(CBCL_total ~1 + smri_t1w_scs_csf_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result32<- brm(model_mediator32+ model_outcome32 + set_rescor(FALSE), data=year3CBCLQC, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result32)
bayestestR::mediation(med_result32, treatment="TBI_3catmildTBI")
#smrit1wscscsfscaled_TBI_3catmildTBI                                0.11      0.11    -0.10     0.32 1.00     9387     2921
#smrit1wscscsfscaled_TBI_3catpossiblemildTBI                        0.03      0.06    -0.10     0.15 1.00     8046     3301
#CBCLtotal_smri_t1w_scs_csf_scaled                                  0.01      0.02    -0.02     0.05 1.00     4510     3365
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1w_scs_csf_scaled
# Response : CBCLtotal
# 
# Effect                 |  Estimate |         95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |     0.592 | [ 0.240, 0.984]
# Indirect Effect (ACME) | 9.183e-04 | [-0.003, 0.010]
# Mediator Effect        |     0.015 | [-0.020, 0.047]
# Total Effect           |     0.594 | [ 0.244, 0.987]
# 
# Proportion mediated: 0.15% [-1.19%, 1.50%]


system.time(model_mediator32b <- bf(smri_t1w_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome32b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1w_scs_csf_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result32b<- brm(model_mediator32b+ model_outcome32b + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result32b)
bayestestR::mediation(med_result32b, treatment="TBI_3catmildTBI")
#smrit1wscscsfscaled_TBI_3catmildTBI                                0.11      0.11    -0.10     0.32 1.00     8023     2852
#smrit1wscscsfscaled_TBI_3catpossiblemildTBI                        0.03      0.06    -0.10     0.16 1.00     8997     2805
#ppsyssseverityscore_smri_t1w_scs_csf_scaled                       -0.05      0.04    -0.12     0.03 1.00     4262     3409

# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.433 | [-0.336, 1.397]
# Indirect Effect (ACME) |   -0.003 | [-0.024, 0.007]
# Mediator Effect        |   -0.046 | [-0.119, 0.033]
# Total Effect           |    0.428 | [-0.340, 1.392]
# 
# Proportion mediated: -0.78% [-15.29%, 13.74%]

######
system.time(model_mediator33c <- bf(brain_stem_vol_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome33c<- bf(pps_y_ss_severity_score ~ 1 + brain_stem_vol_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result33c <- brm(model_mediator33c+ model_outcome33c + set_rescor(FALSE), data=year3QC, cores=4, control=list(adapt_delta=0.80),
                     backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result33c)
bayestestR::mediation(med_result33c, treatment="TBI_3catmildTBI")
#brainstemvolscaled_TBI_3catmildTBI                               -0.09      0.17    -0.42     0.24 1.00     9558     2823
#brainstemvolscaled_TBI_3catpossiblemildTBI                        0.03      0.10    -0.16     0.23 1.00     9246     3029
#ppsyssseverityscore_brain_stem_vol_scaled                        -0.07      0.03    -0.14    -0.01 1.00     7187     2727
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.407 | [-0.356,  1.338]
# Indirect Effect (ACME) |    0.005 | [-0.020,  0.037]
# Mediator Effect        |   -0.073 | [-0.135, -0.012]
# Total Effect           |    0.413 | [-0.353,  1.348]
# 
# Proportion mediated: 1.32% [-22.69%, 25.33%]
# ######

######
system.time(model_mediator33d <- bf(brain_stem_vol_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome33d<- bf(pps_y_ss_severity_score ~ 1 + brain_stem_vol_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result33d <- brm(model_mediator33d+ model_outcome33d + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                     backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))

summary(med_result33d)
bayestestR::mediation(med_result33d, treatment="TBI_3catmildTBI")
######
#removing people with anything but "no abnormal findings"

#####
#total cortical area

system.time(model_mediator33 <- bf(smri_area_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome33 <- bf(CBCL_total ~ 1 + smri_area_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result33<- brm(model_mediator33+ model_outcome33 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result33)
bayestestR::mediation(med_result33, treatment="TBI_3catmildTBI")
#smriareacdktotalscaled_TBI_3catmildTBI                                0.07      0.21    -0.34     0.47 1.00     7624     3041
#smriareacdktotalscaled_TBI_3catpossiblemildTBI                        0.03      0.11    -0.18     0.24 1.00     7558     2998
#CBCLtotal_smri_area_cdk_total_scaled                                 -0.06      0.02    -0.10    -0.03 1.00     5540     3210
# Treatment: TBI_3catmildTBI
# Mediator : smri_area_cdk_total_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.649 | [ 0.208,  1.161]
# Indirect Effect (ACME) |   -0.004 | [-0.031,  0.023]
# Mediator Effect        |   -0.062 | [-0.096, -0.027]
# Total Effect           |    0.644 | [ 0.206,  1.155]
# 
# Proportion mediated: -0.59% [-6.45%, 5.26%]

#####

system.time(model_mediator33b <- bf(smri_area_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome33b <- bf(pps_y_ss_severity_score ~ 1 + smri_area_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+FH_Psychosis+pmq_y_ss_mean+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result33b<- brm(model_mediator33b+ model_outcome33b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result33b)
bayestestR::mediation(med_result33b, treatment="TBI_3catmildTBI")
#smriareacdktotalscaled_TBI_3catmildTBI                                0.07      0.20    -0.33     0.46 1.00    12001     2536
#smriareacdktotalscaled_TBI_3catpossiblemildTBI                        0.03      0.11    -0.18     0.24 1.00    10176     2088
#ppsyssseverityscore_smri_area_cdk_total_scaled                       -0.09      0.04    -0.16    -0.01 1.00     7361     3265
# Treatment: TBI_3catmildTBI
# Mediator : smri_area_cdk_total_scaled
# Response : ppsyssseverityscore
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.337 | [-0.580,  1.638]
# Indirect Effect (ACME) |   -0.004 | [-0.051,  0.032]
# Mediator Effect        |   -0.087 | [-0.157, -0.010]
# Total Effect           |    0.333 | [-0.582,  1.630]
# 
# Proportion mediated: -1.25% [-38.90%, 36.40%]
##########


#######
#total volume

system.time(model_mediator34 <- bf(smri_vol_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome34 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result34<- brm(model_mediator34+ model_outcome34 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result34)
bayestestR::mediation(med_result34, treatment="TBI_3catmildTBI")
#smrivolcdktotalscaled_TBI_3catmildTBI                                0.01      0.20    -0.37     0.38 1.00     8644     2515
#smrivolcdktotalscaled_TBI_3catpossiblemildTBI                        0.06      0.11    -0.15     0.27 1.00    10096     2532
#ppsyssseverityscore_smri_vol_cdk_total_scaled                       -0.13      0.04    -0.20    -0.05 1.00     7708     3140

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_cdk_total_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.340 | [-0.584,  1.623]
# Indirect Effect (ACME) |   -0.001 | [-0.054,  0.052]
# Mediator Effect        |   -0.129 | [-0.205, -0.055]
# Total Effect           |    0.338 | [-0.596,  1.623]
# 
# Proportion mediated: -0.40% [-56.34%, 55.54%]

######

system.time(model_mediator34b <- bf(smri_vol_cdk_total_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome34b<- bf(CBCL_total ~ 1 + smri_vol_cdk_total_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result34b<- brm(model_mediator34b+ model_outcome34b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result34b)
bayestestR::mediation(med_result34b, treatment="TBI_3catmildTBI")

#smrivolcdktotalscaled_TBI_3catmildTBI                                0.00      0.20    -0.38     0.39 1.00    11336     2861
#smrivolcdktotalscaled_TBI_3catpossiblemildTBI                        0.06      0.11    -0.14     0.27 1.00    11321     2556
#CBCLtotal_smri_vol_cdk_total_scaled                                 -0.07      0.02    -0.10    -0.03 1.00     7864     3227

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_cdk_total_scaled
# Response : CBCLtotal
# 
# Effect                 |   Estimate |          95% ETI
# ------------------------------------------------------
#   Direct Effect (ADE)    |      0.623 | [ 0.183,  1.137]
# Indirect Effect (ACME) | -2.365e-04 | [-0.028,  0.027]
# Mediator Effect        |     -0.067 | [-0.101, -0.032]
# Total Effect           |      0.624 | [ 0.180,  1.136]
# 
# Proportion mediated: -0.04% [-6.64%, 6.56%]


#######
#mean cortical thickness
system.time(model_mediator35 <- bf(smri_thick_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome35 <- bf(pps_y_ss_severity_score ~ 1 + smri_thick_cdk_mean_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result35<- brm(model_mediator35+ model_outcome35 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result35)
bayestestR::mediation(med_result35, treatment="TBI_3catmildTBI")

#smrithickcdkmeanscaled_TBI_3catmildTBI                               -0.05      0.21    -0.47     0.37 1.00    10257     2681
#smrithickcdkmeanscaled_TBI_3catpossiblemildTBI                        0.15      0.11    -0.06     0.37 1.00    11022     2727
#ppsyssseverityscore_smri_thick_cdk_mean_scaled                       -0.10      0.04    -0.18    -0.03 1.00     8591     2822

#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.325 | [-0.622,  1.578]
# Indirect Effect (ACME) |    0.005 | [-0.042,  0.054]
# Mediator Effect        |   -0.103 | [-0.178, -0.030]
# Total Effect           |    0.331 | [-0.617,  1.589]
# 
# Proportion mediated: 1.40% [-41.47%, 44.26%]

#####

system.time(model_mediator35b <- bf(smri_thick_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome35b<- bf(CBCL_total ~ 1 + smri_thick_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result35b<- brm(model_mediator35b+ model_outcome35b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result35b)
bayestestR::mediation(med_result35b, treatment="TBI_3catmildTBI")
# smrithickcdkmeanscaled_TBI_3catmildTBI                               -0.05      0.22    -0.48     0.38 1.00     7700     2707
#smrithickcdkmeanscaled_TBI_3catpossiblemildTBI                        0.15      0.12    -0.08     0.38 1.00    12534     2440
#CBCLtotal_smri_thick_cdk_mean_scaled                                 -0.01      0.02    -0.05     0.02 1.00     8203     2707
# Treatment: TBI_3catmildTBI
# Mediator : smri_thick_cdk_mean_scaled
# Response : CBCLtotal
# 
#Effect                 |  Estimate |         95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |     0.619 | [ 0.160, 1.122]
# Indirect Effect (ACME) | 2.014e-04 | [-0.009, 0.013]
# Mediator Effect        |    -0.015 | [-0.047, 0.019]
# Total Effect           |     0.620 | [ 0.163, 1.122]
# 
# Proportion mediated: 0.03% [-2.33%, 2.39%]

######

#mean cortical sulcal depth
system.time(model_mediator36 <- bf(smri_sulc_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome36 <- bf(pps_y_ss_severity_score ~ 1 + smri_sulc_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result36<- brm(model_mediator36+ model_outcome36 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result36)
bayestestR::mediation(med_result36, treatment="TBI_3catmildTBI")
#smrisulccdkmeanscaled_TBI_3catmildTBI                                0.16      0.21    -0.24     0.57 1.00     9583     2768
#smrisulccdkmeanscaled_TBI_3catpossiblemildTBI                       -0.15      0.11    -0.38     0.06 1.00     8901     2570
#ppsyssseverityscore_smri_sulc_cdk_mean_scaled                       -0.07      0.03    -0.14    -0.01 1.00     7526     3036

# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.354 | [-0.608,  1.693]
# Indirect Effect (ACME) |   -0.010 | [-0.053,  0.019]
# Mediator Effect        |   -0.074 | [-0.142, -0.007]
# Total Effect           |    0.342 | [-0.622,  1.676]
# 
# Proportion mediated: -2.92% [-45.52%, 39.69%]



system.time(model_mediator36b <- bf(smri_sulc_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome36b<- bf(CBCL_total ~ 1 + smri_sulc_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result36b<- brm(model_mediator36b+ model_outcome36b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result36b)
bayestestR::mediation(med_result36b, treatment="TBI_3catmildTBI")
#smrisulccdkmeanscaled_TBI_3catmildTBI                                0.16      0.21    -0.25     0.57 1.00     8472     2956
#smrisulccdkmeanscaled_TBI_3catpossiblemildTBI                       -0.15      0.11    -0.37     0.06 1.00     8255     3029
#CBCLtotal_smri_sulc_cdk_mean_scaled                                 -0.01      0.02    -0.04     0.02 1.00     8301     2759

# Treatment: TBI_3catmildTBI
# Mediator : smri_sulc_cdk_mean_scaled
# Response : CBCLtotal
# 
#Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.618 | [ 0.154, 1.140]
# Indirect Effect (ACME) | -7.087e-04 | [-0.014, 0.007]
# Mediator Effect        |     -0.012 | [-0.045, 0.021]
# Total Effect           |      0.617 | [ 0.149, 1.138]
# 
# Proportion mediated: -0.11% [-2.63%, 2.40%]

#####
#intracranial volume
system.time(model_mediator37 <- bf(smri_vol_scs_intracranialv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome37 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_intracranialv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result37<- brm(model_mediator37+ model_outcome37 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, seed=1234, threads = threading(8))
summary(med_result37)
bayestestR::mediation(med_result37, treatment="TBI_3catmildTBI")
#smrivolscsintracranialvscaled_TBI_3catmildTBI                                0.09      0.20    -0.30     0.48 1.00     9355     2831
#smrivolscsintracranialvscaled_TBI_3catpossiblemildTBI                        0.09      0.10    -0.11     0.29 1.00     8490     3156
#ppsyssseverityscore_smri_vol_scs_intracranialv_scaled                       -0.12      0.04    -0.20    -0.05 1.00     7106     2962

#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.362 | [-0.589,  1.693]
# Indirect Effect (ACME) |   -0.010 | [-0.066,  0.038]
# Mediator Effect        |   -0.121 | [-0.198, -0.048]
# Total Effect           |    0.347 | [-0.600,  1.685]
# 
# Proportion mediated: -2.90% [-60.30%, 54.50%]



system.time(model_mediator37b <- bf(smri_vol_scs_intracranialv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome37b<- bf(CBCL_total ~ 1 + smri_vol_scs_intracranialv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result37b<- brm(model_mediator37b+ model_outcome37b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result37b)
bayestestR::mediation(med_result37b, treatment="TBI_3catmildTBI")
#smrivolscsintracranialvscaled_TBI_3catmildTBI                                0.10      0.20    -0.29     0.48 1.00     9374     2968
#smrivolscsintracranialvscaled_TBI_3catpossiblemildTBI                        0.09      0.11    -0.12     0.30 1.00     8559     2930
#CBCLtotal_smri_vol_scs_intracranialv_scaled                                 -0.05      0.02    -0.09    -0.02 1.00     6461     3744
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_intracranialv_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.623 | [ 0.178,  1.119]
# Indirect Effect (ACME) |   -0.004 | [-0.029,  0.017]
# Mediator Effect        |   -0.053 | [-0.089, -0.017]
# Total Effect           |    0.617 | [ 0.169,  1.118]
# 
# Proportion mediated: -0.72% [-6.33%, 4.90%]
######

#scgv
system.time(model_mediator38 <- bf(smri_vol_scs_subcorticalgv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome38 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_subcorticalgv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result38<- brm(model_mediator38+ model_outcome38 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result38)
bayestestR::mediation(med_result38, treatment="TBI_3catmildTBI")
#smrivolscssubcorticalgvscaled_TBI_3catmildTBI                                0.06      0.21    -0.34     0.47 1.00     8784     3289
#smrivolscssubcorticalgvscaled_TBI_3catpossiblemildTBI                        0.13      0.11    -0.08     0.35 1.00     9277     2430
#ppsyssseverityscore_smri_vol_scs_subcorticalgv_scaled                       -0.11      0.04    -0.18    -0.03 1.00     6410     3232

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_subcorticalgv_scaled
# Response : ppsyssseverityscore
# 
# # Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.340 | [-0.618,  1.617]
# Indirect Effect (ACME) |   -0.006 | [-0.059,  0.040]
# Mediator Effect        |   -0.107 | [-0.181, -0.035]
# Total Effect           |    0.334 | [-0.623,  1.617]
# 
# Proportion mediated: -1.73% [-48.94%, 45.49%]


system.time(model_mediator38b <- bf(smri_vol_scs_subcorticalgv_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome38b<- bf(CBCL_total ~ 1 + smri_vol_scs_subcorticalgv_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result38b<- brm(model_mediator38b+ model_outcome38b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result38b)
bayestestR::mediation(med_result38b, treatment="TBI_3catmildTBI")
#smrivolscssubcorticalgvscaled_TBI_3catmildTBI                                0.06      0.20    -0.35     0.45 1.00     8851     2829
#smrivolscssubcorticalgvscaled_TBI_3catpossiblemildTBI                        0.14      0.11    -0.08     0.35 1.00     9417     3032
#CBCLtotal_smri_vol_scs_subcorticalgv_scaled                                 -0.08      0.02    -0.11    -0.04 1.00     7695     3591
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_subcorticalgv_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.619 | [ 0.179,  1.119]
# Indirect Effect (ACME) |   -0.004 | [-0.036,  0.027]
# Mediator Effect        |   -0.075 | [-0.108, -0.043]
# Total Effect           |    0.616 | [ 0.182,  1.116]
# 
# Proportion mediated: -0.63% [-7.66%, 6.40%]

#####

system.time(model_mediator39 <- bf(smri_vol_scs_cbwmatterrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome39 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_cbwmatterrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result39<- brm(model_mediator39+ model_outcome39 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result39)
bayestestR::mediation(med_result39, treatment="TBI_3catmildTBI")
#smrivolscscbwmatterrhscaled_TBI_3catmildTBI                                0.08      0.21    -0.35     0.49 1.00     9360     2895
#smrivolscscbwmatterrhscaled_TBI_3catpossiblemildTBI                        0.10      0.12    -0.13     0.32 1.00     9144     2514
#ppsyssseverityscore_smri_vol_scs_cbwmatterrh_scaled                       -0.11      0.04    -0.18    -0.03 1.00     6801     3232
# 
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterrh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.365 | [-0.584,  1.724]
# Indirect Effect (ACME) |   -0.007 | [-0.059,  0.039]
# Mediator Effect        |   -0.106 | [-0.180, -0.031]
# Total Effect           |    0.356 | [-0.603,  1.718]
# 
# Proportion mediated: -1.95% [-47.29%, 43.40%]

system.time(model_mediator39b <- bf(smri_vol_scs_cbwmatterrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome39b<- bf(CBCL_total ~ 1 + smri_vol_scs_cbwmatterrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result39b<- brm(model_mediator39b+ model_outcome39b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result39b)
bayestestR::mediation(med_result39b, treatment="TBI_3catmildTBI")
#smrivolscscbwmatterrhscaled_TBI_3catmildTBI                                0.07      0.22    -0.36     0.49 1.00    11599     2761
#smrivolscscbwmatterrhscaled_TBI_3catpossiblemildTBI                        0.09      0.11    -0.13     0.32 1.00    10770     2834
#CBCLtotal_smri_vol_scs_cbwmatterrh_scaled                                 -0.07      0.02    -0.10    -0.04 1.00     6886     3047
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterrh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.627 | [ 0.166,  1.155]
# Indirect Effect (ACME) |   -0.004 | [-0.035,  0.026]
# Mediator Effect        |   -0.068 | [-0.100, -0.037]
# Total Effect           |    0.623 | [ 0.166,  1.152]
# 
# Proportion mediated: -0.69% [-8.03%, 6.64%]
#####

system.time(model_mediator40 <- bf(smri_vol_scs_cbwmatterlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome40 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_cbwmatterlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result40<- brm(model_mediator40+ model_outcome40 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result40)
bayestestR::mediation(med_result40, treatment="TBI_3catmildTBI")
#smrivolscscbwmatterlhscaled_TBI_3catmildTBI                                0.08      0.22    -0.34     0.52 1.00    11073     2739
#smrivolscscbwmatterlhscaled_TBI_3catpossiblemildTBI                        0.09      0.11    -0.14     0.32 1.00    11232     2641
#ppsyssseverityscore_smri_vol_scs_cbwmatterlh_scaled                       -0.11      0.04    -0.18    -0.04 1.00     6461     3397
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.378 | [-0.586,  1.676]
# Indirect Effect (ACME) |   -0.007 | [-0.062,  0.042]
# Mediator Effect        |   -0.111 | [-0.184, -0.038]
# Total Effect           |    0.367 | [-0.591,  1.675]
# 
# Proportion mediated: -1.99% [-52.23%, 48.26%]


system.time(model_mediator40b <- bf(smri_vol_scs_cbwmatterlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome40b<- bf(CBCL_total ~ 1 + smri_vol_scs_cbwmatterlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result40b<- brm(model_mediator40b+ model_outcome40b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result40b)
bayestestR::mediation(med_result40b, treatment="TBI_3catmildTBI")
#smrivolscscbwmatterlhscaled_TBI_3catmildTBI                                0.08      0.20    -0.32     0.49 1.00     9685     2933
#smrivolscscbwmatterlhscaled_TBI_3catpossiblemildTBI                        0.09      0.11    -0.13     0.31 1.00     8208     2755
#CBCLtotal_smri_vol_scs_cbwmatterlh_scaled                                 -0.07      0.02    -0.10    -0.03 1.00     6213     2474

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_cbwmatterlh_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.620 | [ 0.173,  1.153]
# Indirect Effect (ACME) |   -0.005 | [-0.035,  0.023]
# Mediator Effect        |   -0.067 | [-0.100, -0.033]
# Total Effect           |    0.616 | [ 0.165,  1.153]
# 
# Proportion mediated: -0.82% [-7.70%, 6.05%]

######

#whole brain volume

system.time(model_mediator41 <- bf(smri_vol_scs_wholeb_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome41 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_wholeb_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result141<- brm(model_mediator41+ model_outcome41 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result41)
bayestestR::mediation(med_result41, treatment="TBI_3catmildTBI")
#smriareacdktotallhscaled_TBI_3catmildTBI                                0.01      0.21    -0.39     0.42 1.00     7678     3003
#smriareacdktotallhscaled_TBI_3catpossiblemildTBI                        0.05      0.11    -0.15     0.26 1.00     6929     3186
#CBCLtotal_smri_area_cdk_totallh_scaled                                 -0.07      0.02    -0.10    -0.03 1.00     5312     3233
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_wholeb_scaled
# Response : ppsyssseverityscore
# 
# Effect                 |   Estimate |          95% ETI
# ------------------------------------------------------
#   Direct Effect (ADE)    |      0.607 | [ 0.126,  1.160]
# Indirect Effect (ACME) | -5.569e-04 | [-0.031,  0.028]
# Mediator Effect        |     -0.067 | [-0.100, -0.032]
# Total Effect           |      0.606 | [ 0.130,  1.158]
# 
# Proportion mediated: -0.09% [-7.26%, 7.07%]


system.time(model_mediator41b <- bf(smri_vol_scs_wholeb_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome41b<- bf(CBCL_total ~ 1 + smri_vol_scs_wholeb_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result41b<- brm(model_mediator41b+ model_outcome41b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result41b)
bayestestR::mediation(med_result41b, treatment="TBI_3catmildTBI")
#smrivolscswholebscaled_TBI_3catmildTBI                                0.06      0.20    -0.33     0.45 1.00    10656     2529
#smrivolscswholebscaled_TBI_3catpossiblemildTBI                        0.08      0.11    -0.14     0.29 1.00     9528     2721
#CBCLtotal_smri_vol_scs_wholeb_scaled                                 -0.08      0.02    -0.11    -0.04 1.00     7010     3099

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_wholeb_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.623 | [ 0.171,  1.151]
# Indirect Effect (ACME) |   -0.005 | [-0.037,  0.028]
# Mediator Effect        |   -0.078 | [-0.114, -0.044]
# Total Effect           |    0.618 | [ 0.165,  1.147]
# 
# Proportion mediated: -0.74% [-8.46%, 6.98%]

####

system.time(model_mediator42 <- bf(smri_vol_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome42 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_csf_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result42<- brm(model_mediator42+ model_outcome42 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result42)
bayestestR::mediation(med_result42, treatment="TBI_3catmildTBI")
#smrivolscscsfscaled_TBI_3catmildTBI                               -0.45      0.20    -0.85    -0.05 1.00    10331     3088
#smrivolscscsfscaled_TBI_3catpossiblemildTBI                        0.07      0.11    -0.15     0.28 1.00    11454     2493
#ppsyssseverityscore_smri_vol_scs_csf_scaled                       -0.09      0.04    -0.16    -0.01 1.00     9896     3394

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_csf_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.298 | [-0.664,  1.592]
# Indirect Effect (ACME) |    0.035 | [ 0.001,  0.094]
# Mediator Effect        |   -0.087 | [-0.160, -0.015]
# Total Effect           |    0.334 | [-0.624,  1.629]
# 
# Proportion mediated: 10.52% [-76.79%, 97.83%]



system.time(model_mediator42b <- bf(smri_vol_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome42b<- bf(CBCL_total ~ 1 + smri_vol_scs_csf_scaled+ TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result42b<- brm(model_mediator42b+ model_outcome42b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.99),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result42b)
bayestestR::mediation(med_result42b, treatment="TBI_3catmildTBI")
#smrivolscscsfscaled_TBI_3catmildTBI                               -0.45      0.21    -0.87    -0.05 1.00    11192     2923
#smrivolscscsfscaled_TBI_3catpossiblemildTBI                        0.07      0.12    -0.16     0.30 1.00     9898     2352
#CBCLtotal_smri_vol_scs_csf_scaled                                 -0.01      0.02    -0.05     0.02 1.00     6765     3085

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_csf_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.614 | [ 0.156, 1.145]
# Indirect Effect (ACME) |    0.005 | [-0.008, 0.026]
# Mediator Effect        |   -0.014 | [-0.046, 0.019]
# Total Effect           |    0.620 | [ 0.164, 1.149]
# 
# Proportion mediated: 0.81% [-3.28%, 4.90%]

####
#all ventricle volume
system.time(model_mediator43 <- bf(smri_vol_scs_allventricles_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome43 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_allventricles_scaled+ TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result43<- brm(model_mediator43+ model_outcome43 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))

summary(med_result43)
#smrivolscsallventriclesscaled_TBI_3catmildTBI                               -0.37      0.22    -0.80     0.05 1.00    11915     2727
#smrivolscsallventriclesscaled_TBI_3catpossiblemildTBI                        0.09      0.11    -0.13     0.31 1.00    11545     2555
#ppsyssseverityscore_smri_vol_scs_allventricles_scaled                        0.02      0.04    -0.05     0.09 1.00    10468     3055


bayestestR::mediation(med_result43, treatment="TBI_3catmildTBI")
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_allventricles_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.349 | [-0.635, 1.682]
# Indirect Effect (ACME) |   -0.004 | [-0.045, 0.023]
# Mediator Effect        |    0.017 | [-0.054, 0.092]
# Total Effect           |    0.343 | [-0.643, 1.671]
# 
# Proportion mediated: -1.13% [-32.15%, 29.88%]



system.time(model_mediator43b <- bf(smri_vol_scs_allventricles_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome43b<- bf(CBCL_total ~ 1 + smri_vol_scs_allventricles_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result43b<- brm(model_mediator43b+ model_outcome43b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result43b)
bayestestR::mediation(med_result43b, treatment="TBI_3catmildTBI")
#smrivolscsallventriclesscaled_TBI_3catmildTBI                               -0.36      0.21    -0.77     0.06 1.00     8821     2946
#smrivolscsallventriclesscaled_TBI_3catpossiblemildTBI                        0.08      0.11    -0.14     0.31 1.00     8897     2670
#CBCLtotal_smri_vol_scs_allventricles_scaled                                  0.01      0.02    -0.02     0.05 1.00     9037     3039

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_allventricles_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.620 | [ 0.167, 1.164]
# Indirect Effect (ACME) |   -0.004 | [-0.024, 0.009]
# Mediator Effect        |    0.014 | [-0.022, 0.049]
# Total Effect           |    0.614 | [ 0.161, 1.157]
# 
# Proportion mediated: -0.59% [-4.40%, 3.21%]

#####


system.time(model_mediator44 <- bf(smri_vol_scs_ltventriclelh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome44<- bf(CBCL_total ~ 1 + smri_vol_scs_ltventriclelh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result44<- brm(model_mediator44+ model_outcome44 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result44)
bayestestR::mediation(med_result44, treatment="TBI_3catmildTBI")
#smrivolscsltventriclelhscaled_TBI_3catmildTBI                               -0.38      0.22    -0.81     0.06 1.00    10609     2284
#smrivolscsltventriclelhscaled_TBI_3catpossiblemildTBI                        0.10      0.11    -0.12     0.32 1.00     8966     2661
#CBCLtotal_smri_vol_scs_ltventriclelh_scaled                                  0.02      0.02    -0.01     0.05 1.00     9985     3127
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclelh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.621 | [ 0.169, 1.164]
# Indirect Effect (ACME) |   -0.006 | [-0.028, 0.006]
# Mediator Effect        |    0.019 | [-0.014, 0.052]
# Total Effect           |    0.614 | [ 0.162, 1.152]
# 
# Proportion mediated: -0.93% [-5.24%, 3.39%]


system.time(model_mediator44b <- bf(smri_vol_scs_ltventriclelh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome44b <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_ltventriclelh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result44b<- brm(model_mediator44b+ model_outcome44b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result44b)
bayestestR::mediation(med_result44b, treatment="TBI_3catmildTBI")
#smrivolscsltventriclelhscaled_TBI_3catmildTBI                               -0.38      0.21    -0.81     0.03 1.00     9817     2506
#smrivolscsltventriclelhscaled_TBI_3catpossiblemildTBI                        0.10      0.11    -0.12     0.32 1.00     9771     2833
#ppsyssseverityscore_smri_vol_scs_ltventriclelh_scaled                        0.01      0.04    -0.05     0.09 1.00     9654     2714
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclelh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.351 | [-0.608, 1.653]
# Indirect Effect (ACME) |   -0.004 | [-0.044, 0.025]
# Mediator Effect        |    0.014 | [-0.055, 0.086]
# Total Effect           |    0.342 | [-0.609, 1.653]
# 
# Proportion mediated: -1.09% [-32.71%, 30.52%]



#######

system.time(model_mediator45 <- bf(smri_vol_scs_ltventriclerh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome45 <- bf(pps_y_ss_severity_score ~1 + smri_vol_scs_ltventriclerh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result45<- brm(model_mediator45+ model_outcome45 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result45)
bayestestR::mediation(med_result45, treatment="TBI_3catmildTBI")
#smrivolscsltventriclerhscaled_TBI_3catmildTBI                               -0.31      0.22    -0.75     0.10 1.00    10304     2696
#smrivolscsltventriclerhscaled_TBI_3catpossiblemildTBI                        0.07      0.11    -0.15     0.29 1.00    10979     3021
#ppsyssseverityscore_smri_vol_scs_ltventriclerh_scaled                        0.03      0.04    -0.04     0.11 1.00     8955     2904
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclerh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.355 | [-0.601, 1.678]
# Indirect Effect (ACME) |   -0.007 | [-0.047, 0.014]
# Mediator Effect        |    0.031 | [-0.041, 0.106]
# Total Effect           |    0.348 | [-0.611, 1.670]
# 
# Proportion mediated: -1.93% [-34.71%, 30.85%]



system.time(model_mediator45b <- bf(smri_vol_scs_ltventriclerh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome45b<- bf(CBCL_total ~1 + smri_vol_scs_ltventriclerh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result45b<- brm(model_mediator45b+ model_outcome45b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result45b)
bayestestR::mediation(med_result45b, treatment="TBI_3catmildTBI")
#smrivolscsltventriclerhscaled_TBI_3catmildTBI                               -0.31      0.21    -0.72     0.10 1.00    11165     2994
#smrivolscsltventriclerhscaled_TBI_3catpossiblemildTBI                        0.07      0.11    -0.15     0.29 1.00     9146     2865
#CBCLtotal_smri_vol_scs_ltventriclerh_scaled                                  0.01      0.02    -0.02     0.05 1.00     8902     3082
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_ltventriclerh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.623 | [ 0.164, 1.130]
# Indirect Effect (ACME) |   -0.003 | [-0.021, 0.007]
# Mediator Effect        |    0.013 | [-0.021, 0.046]
# Total Effect           |    0.619 | [ 0.159, 1.128]
# 
# Proportion mediated: -0.41% [-3.70%, 2.88%]

########

#3rd ventricle
system.time(model_mediator46 <- bf(smri_vol_scs_3rdventricle_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome46 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_3rdventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result46<- brm(model_mediator46+ model_outcome46 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result46)
#smrivolscs3rdventriclescaled_TBI_3catmildTBI                               -0.30      0.22    -0.71     0.12 1.00    11912     2756
#smrivolscs3rdventriclescaled_TBI_3catpossiblemildTBI                        0.01      0.12    -0.23     0.24 1.00    10479     2827
#ppsyssseverityscore_smri_vol_scs_3rdventricle_scaled                       -0.01      0.03    -0.08     0.05 1.00     9037     3168
bayestestR::mediation(med_result46, treatment="TBI_3catmildTBI")
# 
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_3rdventricle_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.330 | [-0.594, 1.580]
# Indirect Effect (ACME) |    0.002 | [-0.021, 0.036]
# Mediator Effect        |   -0.014 | [-0.082, 0.052]
# Total Effect           |    0.331 | [-0.592, 1.586]
# 
# Proportion mediated: 0.69% [-23.83%, 25.20%]


system.time(model_mediator46b <- bf(smri_vol_scs_3rdventricle_scaled ~  1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome46b<- bf(CBCL_total ~ 1 + smri_vol_scs_3rdventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result46b<- brm(model_mediator46b+ model_outcome46b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result46b)
bayestestR::mediation(med_result46b, treatment="TBI_3catmildTBI")
#smrivolscs3rdventriclescaled_TBI_3catmildTBI                               -0.31      0.22    -0.74     0.13 1.00    10878     2492
#smrivolscs3rdventriclescaled_TBI_3catpossiblemildTBI                        0.01      0.11    -0.21     0.23 1.00    10426     2782
#CBCLtotal_smri_vol_scs_3rdventricle_scaled                                 -0.01      0.02    -0.04     0.02 1.00     9203     3011
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_3rdventricle_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.614 | [ 0.171, 1.140]
# Indirect Effect (ACME) |    0.002 | [-0.009, 0.018]
# Mediator Effect        |   -0.010 | [-0.042, 0.024]
# Total Effect           |    0.618 | [ 0.178, 1.139]
# 
# Proportion mediated: 0.29% [-2.95%, 3.52%]

####

system.time(model_mediator47 <- bf(smri_vol_scs_4thventricle_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome47 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_4thventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result47<- brm(model_mediator47+ model_outcome47 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result47)
bayestestR::mediation(med_result47, treatment="TBI_3catmildTBI")
# smrivolscs4thventriclescaled_TBI_3catmildTBI                               -0.36      0.24    -0.83     0.11 1.00    11351     2799
#smrivolscs4thventriclescaled_TBI_3catpossiblemildTBI                        0.07      0.12    -0.18     0.32 1.00    10191     2745
#ppsyssseverityscore_smri_vol_scs_4thventricle_scaled                       -0.06      0.03    -0.12     0.01 1.00     8332     2879
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_4thventricle_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.335 | [-0.659, 1.679]
# Indirect Effect (ACME) |    0.018 | [-0.009, 0.068]
# Mediator Effect        |   -0.059 | [-0.121, 0.008]
# Total Effect           |    0.356 | [-0.645, 1.688]
# 
# Proportion mediated: 5.05% [-48.84%, 58.95%]



system.time(model_mediator47b <- bf(smri_vol_scs_4thventricle_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome47b<- bf(CBCL_total ~ 1 + smri_vol_scs_4thventricle_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result47b<- brm(model_mediator47b+ model_outcome47b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result47b)
bayestestR::mediation(med_result47b, treatment="TBI_3catmildTBI")
#smrivolscs4thventriclescaled_TBI_3catmildTBI                               -0.37      0.24    -0.83     0.09 1.00     9074     2513
#smrivolscs4thventriclescaled_TBI_3catpossiblemildTBI                        0.07      0.13    -0.18     0.32 1.00    10508     2888
#CBCLtotal_smri_vol_scs_4thventricle_scaled                                 -0.02      0.02    -0.05     0.01 1.00     9030     2935
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_4thventricle_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.611 | [ 0.167, 1.124]
# Indirect Effect (ACME) |    0.007 | [-0.004, 0.029]
# Mediator Effect        |   -0.023 | [-0.053, 0.007]
# Total Effect           |    0.619 | [ 0.173, 1.131]
# 
# Proportion mediated: 1.06% [-2.80%, 4.92%]

#####


system.time(model_mediator48 <- bf(smri_vol_scs_inflatventlh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome48 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_inflatventlh.x_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result48<- brm(model_mediator48+ model_outcome48 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.99),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result48)
bayestestR::mediation(med_result48, treatment="TBI_3catmildTBI")
#smrivolscsinflatventlhxscaled_TBI_3catmildTBI                                0.16      0.23    -0.29     0.60 1.00     9700     2238
#smrivolscsinflatventlhxscaled_TBI_3catpossiblemildTBI                       -0.05      0.12    -0.30     0.20 1.00     9499     2513
#ppsyssseverityscore_smri_vol_scs_inflatventlh.x_scaled                      -0.02      0.03    -0.08     0.05 1.01     9612     2401
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_inflatventlh.x_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.358 | [-0.637, 1.706]
# Indirect Effect (ACME) |   -0.001 | [-0.029, 0.015]
# Mediator Effect        |   -0.017 | [-0.081, 0.053]
# Total Effect           |    0.357 | [-0.641, 1.715]
# 
# Proportion mediated: -0.28% [-17.25%, 16.69%]


system.time(model_mediator48b <- bf(smri_vol_scs_inflatventlh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome48b<- bf(CBCL_total ~ 1 + smri_vol_scs_inflatventlh.x_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result48b<- brm(model_mediator48b+ model_outcome48b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result48b)
bayestestR::mediation(med_result48b, treatment="TBI_3catmildTBI")
#smrivolscsinflatventlhxscaled_TBI_3catmildTBI                                0.16      0.23    -0.28     0.61 1.00     9431     2573
#smrivolscsinflatventlhxscaled_TBI_3catpossiblemildTBI                       -0.05      0.12    -0.29     0.20 1.00     9435     2297
#CBCLtotal_smri_vol_scs_inflatventlh.x_scaled                                -0.01      0.02    -0.04     0.03 1.00     9764     3002
# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_inflatventlh.x_scaled
# Response : CBCLtotal
# 
# Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.616 | [ 0.162, 1.162]
# Indirect Effect (ACME) | -2.987e-04 | [-0.012, 0.008]
# Mediator Effect        |     -0.006 | [-0.038, 0.025]
# Total Effect           |      0.615 | [ 0.162, 1.157]
# 
# Proportion mediated: -0.05% [-2.17%, 2.08%]



system.time(model_mediator49 <- bf(smri_vol_scs_inflatventrh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome49 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_inflatventrh.y_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result49<- brm(model_mediator49+ model_outcome49 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.99),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result49)
bayestestR::mediation(med_result49, treatment="TBI_3catmildTBI")
#smrivolscsinflatventrhxscaled_TBI_3catmildTBI                                0.42      0.21     0.02     0.84 1.00     7382     3085
#smrivolscsinflatventrhxscaled_TBI_3catpossiblemildTBI                       -0.12      0.11    -0.33     0.10 1.00     5568     2851
#ppsyssseverityscore_smri_vol_scs_inflatventrh.x_scaled                       0.03      0.04    -0.04     0.10 1.00     6574     2802

# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.315 | [-0.644, 1.665]
# Indirect Effect (ACME) |    0.010 | [-0.018, 0.058]
# Mediator Effect        |    0.030 | [-0.042, 0.104]
# Total Effect           |    0.328 | [-0.630, 1.676]
# 
# Proportion mediated: 2.97% [-42.08%, 48.03%]


system.time(model_mediator49b <- bf(smri_vol_scs_inflatventrh.x_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome49b<- bf(CBCL_total ~ 1 + smri_vol_scs_inflatventrh.x_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
system.time(med_result49b<- brm(model_mediator49b+ model_outcome49b + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.99),
                                backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8)))

summary(med_result49b)
bayestestR::mediation(med_result49b, treatment="TBI_3catmildTBI")
#smrivolscsinflatventrhxscaled_TBI_3catmildTBI                                0.42      0.21     0.01     0.82 1.00     7731     2920
#smrivolscsinflatventrhxscaled_TBI_3catpossiblemildTBI                       -0.12      0.11    -0.35     0.11 1.00     7601     2799
#CBCLtotal_smri_vol_scs_inflatventrh.x_scaled                                 0.03      0.02    -0.01     0.06 1.00     7826     2906

# Treatment: TBI_3catmildTBI
# Mediator : smri_vol_scs_inflatventrh.x_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.612 | [ 0.146, 1.127]
# Indirect Effect (ACME) |    0.009 | [-0.003, 0.033]
# Mediator Effect        |    0.026 | [-0.006, 0.058]
# Total Effect           |    0.622 | [ 0.156, 1.138]
# 
# Proportion mediated: 1.49% [-2.91%, 5.89%]

####
#dlprefrlh


system.time(model_mediator50 <- bf(smri_t1wcnt_cf12_dlprefrlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome50<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf12_dlprefrlh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result50<- brm(model_mediator50+ model_outcome50 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result50)
bayestestR::mediation(med_result50, treatment="TBI_3catmildTBI")
#smrit1wcntcf12dlprefrlhscaled_TBI_3catmildTBI                               -0.12      0.15    -0.41     0.16 1.00     8230     2978
#smrit1wcntcf12dlprefrlhscaled_TBI_3catpossiblemildTBI                       -0.04      0.08    -0.20     0.12 1.00     8348     2804
#CBCLtotal_smri_t1wcnt_cf12_dlprefrlh_scaled                                 -0.04      0.02    -0.08    -0.01 1.00     4770     3262
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf12_dlprefrlh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# Direct Effect (ADE)    |    0.605 | [ 0.154,  1.149]
# Indirect Effect (ACME) |    0.004 | [-0.007,  0.022]
# Mediator Effect        |   -0.043 | [-0.082, -0.006]
# Total Effect           |    0.612 | [ 0.160,  1.155]
# 
# Proportion mediated: 0.72% [-2.81%, 4.26%]



system.time(model_mediator50b <- bf(smri_t1wcnt_cf12_dlprefrlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome50b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf12_dlprefrlh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result50b<- brm(model_mediator50b+ model_outcome50b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result50b)
bayestestR::mediation(med_result50b, treatment="TBI_3catmildTBI")
#smrit1wcntcf12dlprefrlhscaled_TBI_3catmildTBI                               -0.12      0.15    -0.43     0.18 1.00     6180     2601
#smrit1wcntcf12dlprefrlhscaled_TBI_3catpossiblemildTBI                       -0.04      0.08    -0.20     0.12 1.00     6753     2946
#ppsyssseverityscore_smri_t1wcnt_cf12_dlprefrlh_scaled                       -0.10      0.05    -0.19    -0.01 1.00     3198     3217
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf12_dlprefrlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.343 | [-0.572,  1.593]
# Indirect Effect (ACME) |    0.010 | [-0.019,  0.055]
# Mediator Effect        |   -0.097 | [-0.194, -0.011]
# Total Effect           |    0.357 | [-0.567,  1.606]
# 
# Proportion mediated: 2.68% [-35.88%, 41.24%]

#########
#frontal lh
system.time(model_mediator51 <- bf(smri_t1wcnt_cf2_frlh_scaled ~1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome51<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_frlh_scaled + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result51<- brm(model_mediator51+ model_outcome51 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result51)
bayestestR::mediation(med_result51, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frlhscaled_TBI_3catmildTBI                               -0.09      0.14    -0.37     0.19 1.00     6431     3013
#smrit1wcntcf2frlhscaled_TBI_3catpossiblemildTBI                       -0.02      0.07    -0.16     0.13 1.00     6229     2746
#CBCLtotal_smri_t1wcnt_cf2_frlh_scaled                                 -0.04      0.02    -0.08    -0.00 1.00     4044     3168

# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_frlh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.617 | [ 0.170,  1.133]
# Indirect Effect (ACME) |    0.003 | [-0.009,  0.019]
# Mediator Effect        |   -0.041 | [-0.081, -0.002]
# Total Effect           |    0.620 | [ 0.172,  1.134]
# 
# Proportion mediated: 0.45% [-2.60%, 3.50%]

system.time(model_mediator51b <- bf(smri_t1wcnt_cf2_frlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome51b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_frlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result51b<- brm(model_mediator51b+ model_outcome51b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result51b)
bayestestR::mediation(med_result51b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frlhscaled_TBI_3catmildTBI                               -0.09      0.14    -0.36     0.18 1.00     6465     3081
#smrit1wcntcf2frlhscaled_TBI_3catpossiblemildTBI                       -0.02      0.08    -0.17     0.13 1.00     6291     2646
#ppsyssseverityscore_smri_t1wcnt_cf2_frlh_scaled                       -0.09      0.05    -0.19    -0.00 1.00     3313     2593

# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_frlh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.339 | [-0.591,  1.671]
# Indirect Effect (ACME) |    0.006 | [-0.019,  0.043]
# Mediator Effect        |   -0.090 | [-0.187, -0.001]
# Total Effect           |    0.350 | [-0.587,  1.672]
# 
# Proportion mediated: 1.64% [-28.24%, 31.52%]
########

system.time(model_mediator52 <- bf(smri_t1wcnt_cf2_frrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome52<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_frrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result52<- brm(model_mediator52+ model_outcome52 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result52)
bayestestR::mediation(med_result52, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frrhscaled_TBI_3catmildTBI                               -0.10      0.14    -0.38     0.18 1.00     7207     2874
#smrit1wcntcf2frrhscaled_TBI_3catpossiblemildTBI                       -0.06      0.07    -0.21     0.08 1.00     9743     3061
#CBCLtotal_smri_t1wcnt_cf2_frrh_scaled                                 -0.05      0.02    -0.09    -0.01 1.00     4277     3493
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.612 | [ 0.195,  1.106]
# Indirect Effect (ACME) |    0.004 | [-0.009,  0.022]
# Mediator Effect        |   -0.047 | [-0.088, -0.008]
# Total Effect           |    0.618 | [ 0.201,  1.116]
# 
# Proportion mediated: 0.63% [-2.84%, 4.10%]
# #####

system.time(model_mediator52b <- bf(smri_t1wcnt_cf2_frrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome52b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_frrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result52b<- brm(model_mediator52b+ model_outcome52b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result52b)
bayestestR::mediation(med_result52b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2frrhscaled_TBI_3catmildTBI                               -0.10      0.14    -0.38     0.17 1.00     5155     2932
#smrit1wcntcf2frrhscaled_TBI_3catpossiblemildTBI                       -0.06      0.07    -0.21     0.09 1.00     5712     2887
#ppsyssseverityscore_smri_t1wcnt_cf2_frrh_scaled                       -0.09      0.05    -0.19    -0.00 1.00     2517     3032
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_frrh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.339 | [-0.611,  1.639]
# Indirect Effect (ACME) |    0.008 | [-0.017,  0.048]
# Mediator Effect        |   -0.093 | [-0.194, -0.002]
# Total Effect           |    0.348 | [-0.603,  1.643]
# 
# Proportion mediated: 2.18% [-31.43%, 35.79%]

########

system.time(model_mediator53 <- bf(smri_t1wcnt_cf2_ptrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome53<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_ptrh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result53<- brm(model_mediator53+ model_outcome53 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result53)
bayestestR::mediation(med_result53, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptrhscaled_TBI_3catmildTBI                               -0.08      0.13    -0.33     0.18 1.00    11086     2805
#smrit1wcntcf2ptrhscaled_TBI_3catpossiblemildTBI                       -0.02      0.07    -0.17     0.12 1.00     9445     2681
#CBCLtotal_smri_t1wcnt_cf2_ptrh_scaled                                 -0.05      0.02    -0.09    -0.01 1.00     4582     3236
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_ptrh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.609 | [ 0.165,  1.146]
# Indirect Effect (ACME) |    0.003 | [-0.010,  0.020]
# Mediator Effect        |   -0.048 | [-0.087, -0.008]
# Total Effect           |    0.612 | [ 0.167,  1.151]
# 
# Proportion mediated: 0.51% [-2.86%, 3.89%]

system.time(model_mediator53b <- bf(smri_t1wcnt_cf2_ptrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome53b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_ptrh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result53b<- brm(model_mediator53b+ model_outcome53b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result53b)
bayestestR::mediation(med_result53b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptrhscaled_TBI_3catmildTBI                               -0.08      0.14    -0.35     0.18 1.00     7471     2443
#smrit1wcntcf2ptrhscaled_TBI_3catpossiblemildTBI                       -0.02      0.07    -0.16     0.12 1.00    10374     2956
#ppsyssseverityscore_smri_t1wcnt_cf2_ptrh_scaled                       -0.08      0.05    -0.18     0.02 1.00     2890     2873
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.330 | [-0.639, 1.668]
# Indirect Effect (ACME) |    0.004 | [-0.017, 0.038]
# Mediator Effect        |   -0.076 | [-0.178, 0.016]
# Total Effect           |    0.340 | [-0.633, 1.675]
# 
# Proportion mediated: 1.17% [-22.78%, 25.13%]

#######


system.time(model_mediator54 <- bf(smri_t1wcnt_cf2_ptlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome54<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf2_ptlh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result54<- brm(model_mediator54+ model_outcome54 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result54)
bayestestR::mediation(med_result54, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptlhscaled_TBI_3catmildTBI                               -0.13      0.14    -0.41     0.15 1.00     9261     2879
#smrit1wcntcf2ptlhscaled_TBI_3catpossiblemildTBI                       -0.01      0.08    -0.16     0.14 1.00    10312     2500
#CBCLtotal_smri_t1wcnt_cf2_ptlh_scaled                                 -0.05      0.02    -0.09    -0.01 1.00     4748     2939
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_ptlh_scaled
# Response : CBCLtotal
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.596 | [ 0.158,  1.122]
# Indirect Effect (ACME) |    0.005 | [-0.008,  0.024]
# Mediator Effect        |   -0.046 | [-0.087, -0.008]
# Total Effect           |    0.602 | [ 0.166,  1.127]
# 
# Proportion mediated: 0.86% [-2.87%, 4.60%]

########

system.time(model_mediator54b <- bf(smri_t1wcnt_cf2_ptlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome54b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cf2_ptlh_scaled   + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result54b<- brm(model_mediator54b+ model_outcome54b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result54b)
bayestestR::mediation(med_result54b, treatment="TBI_3catmildTBI")
#smrit1wcntcf2ptlhscaled_TBI_3catmildTBI                               -0.13      0.15    -0.42     0.16 1.00     9460     2978
#smrit1wcntcf2ptlhscaled_TBI_3catpossiblemildTBI                       -0.01      0.08    -0.15     0.14 1.00     9600     2874
#ppsyssseverityscore_smri_t1wcnt_cf2_ptlh_scaled                       -0.08      0.05    -0.17     0.01 1.00     3746     3298
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf2_ptlh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |         95% ETI
# ---------------------------------------------------
#   Direct Effect (ADE)    |    0.343 | [-0.567, 1.578]
# Indirect Effect (ACME) |    0.007 | [-0.013, 0.044]
# Mediator Effect        |   -0.074 | [-0.169, 0.011]
# Total Effect           |    0.354 | [-0.550, 1.587]
# 
# Proportion mediated: 1.95% [-29.73%, 33.64%]

system.time(model_mediator55 <- bf(smri_t1wcnt_cf12_dlprefrrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome55<- bf(CBCL_total ~ 1 + smri_t1wcnt_cf12_dlprefrrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result55<- brm(model_mediator55+ model_outcome55 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result55)
bayestestR::mediation(med_result55, treatment="TBI_3catmildTBI")
# smrit1wcntcf12dlprefrrhscaled_TBI_3catmildTBI                               -0.11      0.16    -0.42     0.19 1.00     6070     3174
# smrit1wcntcf12dlprefrrhscaled_TBI_3catpossiblemildTBI                       -0.09      0.08    -0.25     0.08 1.00     5745     2758
#CBCLtotal_smri_t1wcnt_cf12_dlprefrrh_scaled                                 -0.05      0.02    -0.09    -0.01 1.00     4315     3496
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cf12_dlprefrrh_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.610 | [ 0.174,  1.130]
# Indirect Effect (ACME) |    0.005 | [-0.010,  0.025]
# Mediator Effect        |   -0.049 | [-0.086, -0.012]
# Total Effect           |    0.614 | [ 0.184,  1.132]
# 
# Proportion mediated: 0.77% [-3.24%, 4.79%]

#####

system.time(model_mediator55b <- bf(smri_t1wcnt_cf12_dlprefrrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome55b <- bf(pps_y_ss_severity_score ~  1 + smri_t1wcnt_cf12_dlprefrrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result55b<- brm(model_mediator55b+ model_outcome55b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result28b)
bayestestR::mediation(med_result28b, treatment="TBI_3catmildTBI")
# smrit1wcntcf12dlprefrrhscaled_TBI_3catmildTBI                               -0.15      0.12    -0.40     0.09 1.00     6068     2908
#smrit1wcntcf12dlprefrrhscaled_TBI_3catpossiblemildTBI                       -0.02      0.07    -0.16     0.12 1.00     6954     2903
#CBCLtotal_smri_t1wcnt_cf12_dlprefrrh_scaled                                 -0.05      0.02    -0.09    -0.01 1.00     4315     3496
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.379 | [-0.372,  1.323]
# Indirect Effect (ACME) |    0.015 | [-0.009,  0.052]
# Mediator Effect        |   -0.109 | [-0.191, -0.030]
# Total Effect           |    0.393 | [-0.362,  1.342]
# 
# Proportion mediated: 3.71% [-38.46%, 45.89%]

######


system.time(model_mediator56 <- bf(smri_t1wcnt_cdk_meanlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome56<- bf(CBCL_total ~ 1 + smri_t1wcnt_cdk_meanlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result56<- brm(model_mediator56+ model_outcome56 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result56)
#smrit1wcntcdkmeanlhscaled_TBI_3catmildTBI                               -0.13      0.14    -0.41     0.15 1.00     9063     2899
#smrit1wcntcdkmeanlhscaled_TBI_3catpossiblemildTBI                       -0.01      0.08    -0.17     0.14 1.00     9142     2797
#CBCLtotal_smri_t1wcnt_cdk_meanlh_scaled                                 -0.05      0.02    -0.08    -0.01 1.00     5360     3676
bayestestR::mediation(med_result56, treatment="TBI_3catmildTBI")
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanlh_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.608 | [ 0.178,  1.118]
# Indirect Effect (ACME) |    0.005 | [-0.007,  0.023]
# Mediator Effect        |   -0.046 | [-0.085, -0.008]
# Total Effect           |    0.613 | [ 0.181,  1.127]
# 
# Proportion mediated: 0.81% [-2.65%, 4.26%]


system.time(model_mediator56b <- bf(smri_t1wcnt_cdk_meanlh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome56b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cdk_meanlh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result56b<- brm(model_mediator56b+ model_outcome56b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result56b)
bayestestR::mediation(med_result56b, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanlhscaled_TBI_3catmildTBI                               -0.13      0.15    -0.42     0.16 1.00     6918     3204
#smrit1wcntcdkmeanlhscaled_TBI_3catpossiblemildTBI                       -0.01      0.08    -0.17     0.14 1.00     8475     3169
#ppsyssseverityscore_smri_t1wcnt_cdk_meanlh_scaled                       -0.09      0.05    -0.19    -0.01 1.00     2813     3274
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanlh_scaled
# Response : ppsyssseverityscore
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.338 | [-0.599,  1.664]
# Indirect Effect (ACME) |    0.010 | [-0.016,  0.053]
# Mediator Effect        |   -0.091 | [-0.188, -0.007]
# Total Effect           |    0.352 | [-0.588,  1.672]
# 
# Proportion mediated: 2.72% [-39.31%, 44.75%]


######

system.time(model_mediator57 <- bf(smri_t1wcnt_cdk_meanrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome57<- bf(CBCL_total ~ 1 + smri_t1wcnt_cdk_meanrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result57<- brm(model_mediator57+ model_outcome57 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result57)
bayestestR::mediation(med_result57, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanrhscaled_TBI_3catmildTBI                               -0.10      0.14    -0.35     0.17 1.00     9697     2952
#smrit1wcntcdkmeanrhscaled_TBI_3catpossiblemildTBI                       -0.05      0.07    -0.19     0.10 1.00     9875     2329
#CBCLtotal_smri_t1wcnt_cdk_meanrh_scaled                                 -0.05      0.02    -0.09    -0.01 1.00     5788     3419
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanrh_scaled
# Response : CBCLtotal
# 
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.611 | [ 0.172,  1.139]
# Indirect Effect (ACME) |    0.004 | [-0.009,  0.023]
# Mediator Effect        |   -0.050 | [-0.090, -0.010]
# Total Effect           |    0.616 | [ 0.180,  1.145]
# 
# Proportion mediated: 0.68% [-3.08%, 4.44%]



system.time(model_mediator57b <- bf(smri_t1wcnt_cdk_meanrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome57b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cdk_meanrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result57b<- brm(model_mediator57b+ model_outcome57b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result57b)
bayestestR::mediation(med_result57b, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanrhscaled_TBI_3catmildTBI                               -0.09      0.14    -0.38     0.19 1.00     5994     2883
#smrit1wcntcdkmeanrhscaled_TBI_3catpossiblemildTBI                       -0.05      0.07    -0.19     0.10 1.00     7565     2642
#ppsyssseverityscore_smri_t1wcnt_cdk_meanrh_scaled                       -0.10      0.05    -0.20    -0.01 1.00     2756     3159

# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_meanrh_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.348 | [-0.605,  1.651]
# Indirect Effect (ACME) |    0.007 | [-0.020,  0.048]
# Mediator Effect        |   -0.096 | [-0.198, -0.006]
# Total Effect           |    0.353 | [-0.587,  1.666]
# 
# Proportion mediated: 1.97% [-34.54%, 38.49%]

#######

system.time(model_mediator58 <- bf(smri_t1wcnt_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome58<- bf(CBCL_total ~ 1 + smri_t1wcnt_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result58<- brm(model_mediator58+ model_outcome58 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result58)
bayestestR::mediation(med_result58, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanscaled_TBI_3catmildTBI                               -0.11      0.14    -0.40     0.16 1.00     8886     2723
#smrit1wcntcdkmeanscaled_TBI_3catpossiblemildTBI                       -0.03      0.08    -0.18     0.11 1.00     9014     2833
#CBCLtotal_smri_t1wcnt_cdk_mean_scaled                                 -0.05      0.02    -0.09    -0.01 1.00     5213     3613

# 
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_mean_scaled
# Response : CBCLtotal
# 
#Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.617 | [ 0.174,  1.106]
# Indirect Effect (ACME) |    0.004 | [-0.009,  0.023]
# Mediator Effect        |   -0.049 | [-0.087, -0.011]
# Total Effect           |    0.622 | [ 0.178,  1.110]
# 
# Proportion mediated: 0.71% [-2.88%, 4.29%]


system.time(model_mediator58b <- bf(smri_t1wcnt_cdk_mean_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome58b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1wcnt_cdk_mean_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result58b<- brm(model_mediator58b+ model_outcome58b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result58b)
bayestestR::mediation(med_result58b, treatment="TBI_3catmildTBI")
#smrit1wcntcdkmeanscaled_TBI_3catmildTBI                               -0.11      0.15    -0.40     0.18 1.00    11926     2124
#smrit1wcntcdkmeanscaled_TBI_3catpossiblemildTBI                       -0.03      0.08    -0.18     0.12 1.00     8333     2838
#ppsyssseverityscore_smri_t1wcnt_cdk_mean_scaled                       -0.10      0.05    -0.20    -0.00 1.00     3219     2925
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1wcnt_cdk_mean_scaled
# Response : ppsyssseverityscore
# 
# Effect                 | Estimate |          95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |    0.331 | [-0.627,  1.578]
# Indirect Effect (ACME) |    0.008 | [-0.018,  0.050]
# Mediator Effect        |   -0.095 | [-0.195, -0.005]
# Total Effect           |    0.345 | [-0.612,  1.586]
# 
# Proportion mediated: 2.38% [-36.69%, 41.45%]

#####

system.time(model_mediator59 <- bf(smri_t1w_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome59<- bf(CBCL_total ~1 + smri_t1w_scs_csf_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                   high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result59<- brm(model_mediator59+ model_outcome59 + set_rescor(FALSE), data=year3CBCLQC_noIF, cores=4, control=list(adapt_delta=0.80),
                   backend="cmdstanr", seed=1234, warmup = 1000, threads = threading(8))
summary(med_result59)
bayestestR::mediation(med_result59, treatment="TBI_3catmildTBI")
#smrit1wscscsfscaled_TBI_3catmildTBI                                0.01      0.13    -0.24     0.26 1.00     9474     2762
#smrit1wscscsfscaled_TBI_3catpossiblemildTBI                        0.05      0.07    -0.08     0.19 1.00     9040     3197
#CBCLtotal_smri_t1w_scs_csf_scaled                                  0.01      0.02    -0.03     0.05 1.00     4994     3419
# Treatment: TBI_3catmildTBI
# Mediator : smri_t1w_scs_csf_scaled
# Response : CBCLtotal
# 
#Effect                 |  Estimate |         95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |     0.630 | [ 0.178, 1.145]
# Indirect Effect (ACME) | 7.811e-06 | [-0.006, 0.007]
# Mediator Effect        |     0.013 | [-0.029, 0.053]
# Total Effect           |     0.629 | [ 0.180, 1.147]
# 
# Proportion mediated: 1.24e-03% [-1.36%, 1.37%]


system.time(model_mediator59b <- bf(smri_t1w_scs_csf_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                    +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome59b <- bf(pps_y_ss_severity_score ~ 1 + smri_t1w_scs_csf_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                     high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result59b<- brm(model_mediator59b+ model_outcome59b + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.80),
                    backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result59b)
bayestestR::mediation(med_result59b, treatment="TBI_3catmildTBI")
#smrit1wscscsfscaled_TBI_3catmildTBI                                0.01      0.13    -0.25     0.26 1.00     9339     2802
#smrit1wscscsfscaled_TBI_3catpossiblemildTBI                        0.05      0.07    -0.09     0.18 1.00    10391     2661
#ppsyssseverityscore_smri_t1w_scs_csf_scaled                       -0.04      0.05    -0.13     0.05 1.00     4652     3097

# Effect                 |   Estimate |         95% ETI
# -----------------------------------------------------
#   Direct Effect (ADE)    |      0.352 | [-0.604, 1.623]
# Indirect Effect (ACME) | -7.692e-05 | [-0.018, 0.015]
# Mediator Effect        |     -0.039 | [-0.129, 0.050]
# Total Effect           |      0.352 | [-0.604, 1.622]
# 
# Proportion mediated: -0.02% [-13.10%, 13.06%]

####
system.time(model_mediator60 <- bf(smri_vol_scs_inflatventlh.x ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome60 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_inflatventlh.x  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result60<- brm(model_mediator60+ model_outcome60 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.99),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result60)
bayestestR::mediation(med_result60, treatment="TBI_3catmildTBI")
#smrivolscsinflatventlhx_TBI_3catmildTBI                               24.97     34.99   -44.70    92.02 1.00     5669     3000
#smrivolscsinflatventlhx_TBI_3catpossiblemildTBI                       -7.65     17.49   -41.84    26.14 1.00     5155     3040

##
system.time(model_mediator61 <- bf(smri_vol_scs_inflatventrh.x ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome61 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_scs_inflatventrh.x  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result61<- brm(model_mediator61+ model_outcome61 + set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.99),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result61)
bayestestR::mediation(med_result61, treatment="TBI_3catmildTBI")
# Effect                 |  Estimate |         95% ETI
# ----------------------------------------------------
#   Direct Effect (ADE)    |     0.327 | [-0.624, 1.639]
# Indirect Effect (ACME) |     0.010 | [-0.018, 0.056]
# Mediator Effect        | 1.915e-04 | [ 0.000, 0.001]
# Total Effect           |     0.341 | [-0.611, 1.644]
# 
# Proportion mediated: 2.94% [-39.50%, 45.38%]
# smrivolscsinflatventrhx_TBI_3catmildTBI                               65.66     33.57    -0.86   132.04 1.00     6928     2944
# smrivolscsinflatventrhx_TBI_3catpossiblemildTBI                      -18.45     17.28   -53.04    15.20 1.00     7544     2857



system.time(model_mediator62 <- bf(smri_vol_subcortaseg_inflatventrh_scaled ~ 1 + TBI_3cat + interview_age_scaled+ sex+race_ethnicity+ household.income.bl+mri_info_manufacturer+high.educ.bl
                                   +rel_relationship+(1 |rel_family_id | abcd_site)))
system.time(model_outcome62 <- bf(pps_y_ss_severity_score ~ 1 + smri_vol_subcortaseg_inflatventrh_scaled  + TBI_3cat +interview_age_scaled+sex+race_ethnicity+household.income.bl+
                                    high.educ.bl+rel_relationship+married.bl+pmq_y_ss_mean+FH_Psychosis+neighborhood_crime_y+(1 |rel_family_id | abcd_site),family=negbinomial()))
med_result62<- brm(model_mediator62+ model_outcome62+ set_rescor(FALSE), data=year3QC_noIF, cores=4, control=list(adapt_delta=0.99),
                   backend="cmdstanr", warmup = 1000, threads = threading(8))
summary(med_result62)
bayestestR::mediation(med_result62, treatment="TBI_3catmildTBI")
#smrivolsubcortaseginflatventrhscaled_TBI_3catmildTBI                                0.42      0.21     0.00     0.85 1.00     7123     2683
#smrivolsubcortaseginflatventrhscaled_TBI_3catpossiblemildTBI                       -0.12      0.11    -0.34     0.10 1.00     6878     2759
#ppsyssseverityscore_smri_vol_subcortaseg_inflatventrh_scaled                        0.03      0.04    -0.04     0.11 1.00     5559     2878
#######

#example of how tables were made for the paper

library(tableone)
myVars <- c("TBI_3cat", 
            "visit",   "hhincome_catm")

catVars <- c( "TBI_3cat", 
              "visit",   "hhincome_catm")

tab3 <- CreateTableOne(vars=myVars, strata=c("TBI_3cat", "visit"), data=ABCD_TBI, factorVars=catVars)

#######
#obtaining standard errors for pps severity score and CBCL total

xy <- ABCD_TBI[,c("src_subject_id", "visit", "TBIbin", "pps_y_ss_severity_score", "CBCL_total", "sex", "race_ethnicity", "hhincome_cat", "high_educ", 
                  "TBI_3cat", "FH_Psychosis", "marital_allvisits", "neighborhood_crime_y")]

grpMT <- xy %>% 
  group_by(visit)

grpMT %>%
  summarise_each(funs(mean(., na.rm=T), n = sum(!is.na(.)), se = sd(., na.rm=T)/sqrt(sum(!is.na(.)))), pps_y_ss_severity_score:CBCL_total)

#######
#sensitivity analysis looking at TBI as a binary yes/no with moderate and severe TBI included
table(ABCD_TBI$visit, ABCD_TBI$TBIbin)
# 
#    No     Yes
# 1 11415   457
# 2 11072   138
# 3 10217   143
#now it includes the 12 observations where a participant reported a moderate or severe TBI 
 

system.time(Model_PPSbin <- glmmTMB(pps_y_ss_severity_score ~ 1+ visit+sex+interview_age+race_ethnicity+
                                      high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                      pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBIbin+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                                 family=nbinom2, data=ABCD_TBI,  control = glmmTMBControl(parallel = 16)))
summary(Model_PPSbin)
#TBIbinYes                           0.1547591  0.0745506   2.076 0.037904 *    
exp(0.1547591)
#1.167377
#16.7% increased risk 


exp(confint(Model_PPSbin))
#cond.TBIbinYes                            1.0086801    1.3510411   1.1673767
#95% CI is 0.8% to 35.1%. 
#Number of obs: 30261
#######

system.time(Model_CBCLbin <- glmmTMB(CBCL_total ~ 1+ visit+sex+interview_age+race_ethnicity+
                                       high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                       pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBIbin+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                                    family=nbinom2, data=ABCD_TBI,  control = glmmTMBControl(parallel = 16)))
summary(Model_CBCLbin)
#TBIbinYes                           0.0883608  0.0246963   3.578 0.000346 ***
exp(0.0883608)
#9.2% increased risk 
#1.092382
exp(confint(Model_CBCLbin))
#cond.TBIbinYes                          1.0407659  1.1465584  1.0923822
#95% CI 4.08% to 14.66%
#Number of obs: 30263
####
#MI

#FIRST STEP : MISSING DATA INSPECTION

colSums(is.na(ABCD_TBI))


round(colSums(is.na(ABCD_TBI))/nrow(ABCD_TBI)*100,2)
#household_income        FH_Psychosis 
#      8.23                   1.19

md.pattern(ABCD_TBI)
md.pairs(ABCD_TBI)$mr

#separating the variables I need
dat3 <- ABCD_TBI[, c("src_subject_id", "visit", "rel_family_id", "abcd_site", "pps_y_ss_severity_score", "sex", "interview_age", 
                     "race_ethnicity", "household.income.bl", "rel_relationship", "neighborhood_crime_y", "high.educ.bl", "FH_Psychosis", "TBI_3cat", "marital_allvisits",
                     "pmq_y_ss_mean", "CBCL_total", "TBIbin")]

#convert id to an integer
dat3$src_subject_id <- as.integer(dat3$src_subject_id)

#converting all character to factor
dat3[sapply(dat3, is.character)] <- lapply(dat3[sapply(dat3, is.character)], 
                                           as.factor)
str(dat3)


ini <- mice(dat3, maxit=0) #dat1 is already in long form. 
method <- ini$method
method["household.income.bl"] <- "pmm"  #using predictive mean matching for household income
pred <- ini$pred
pred["household.income.bl", ] <- c(-2, 2, 2, 2, 1, 1, 1, 1, 1,1,1, 1,1, 1, 1, 1, 1, 1)
#0 means not included in imputation model, 1 denotes fixed effect, 2 a fixed and random effect, 
#-2 identifies the class variable.

ini$predictorMatrix

pred #predictormatrix

#20 imputations with 20 iterations and 3 donors. 
system.time(imp.pmm5 <- parlmice(dat3, cluster.seed=123453, method = method, pred = pred, maxit=20, donors=3, n.core=10, n.imp.core=2,  print = TRUE))
summary(imp.pmm5)
#################
#pooling the data sets for parameter estimation 
#################

cor2fisher <- function(r) {(1/2*log( ( 1 + r) / ( 1 - r ) ))  }
fisher2cor <- function(z) {( exp(2*z) - 1 )/ ( exp(2*z) + 1 ) }

est <- se <- rvar <- rcor <- vector(length=100, mode= "list")

for (i in 1:10) {
  cat(i, "\n")
  com <- complete(imp.pmm5, i)
  nb2modelFull4 <- glmmTMB::glmmTMB(pps_y_ss_severity_score ~ 1+ visit+sex+interview_age+race_ethnicity+
                                      high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                      pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBIbin+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                                    family=nbinom2, data=com,  control = glmmTMBControl(parallel = 16))
  s <- summary(nb2modelFull4)
  est[[i]] <- s$coefficients$cond[, 1]
  se[[i]] <- s$coefficients$cond[, 2]
  rvar[[i]] <- 
    attr(glmmTMB::VarCorr(nb2modelFull4)[[1]]$"src_subject_id", "stddev")^2
  #rcor[[i]] <- cor2fisher(attr(
  # glmmTMB::VarCorr(nb2modelFull1)[[1]]$"ID",
  #"correlation"
  
}

s

#TBIbinYes                          0.207470   0.071130   2.917 0.003537 **   
exp(0.207470)
#1.230561

exp(confint(nb2modelFull4))
#                                             2.5 %       97.5 %    Estimate
#cond.TBIbinYes                            1.0578228    1.3960099   1.2152083

######

est <- se <- rvar <- rcor <- vector(length=100, mode= "list")

for (i in 1:10) {
  cat(i, "\n")
  com <- complete(imp.pmm5, i)
  nb2modelFull5 <- glmmTMB::glmmTMB(CBCL_total ~ 1+ visit+sex+interview_age+race_ethnicity+
                                      high.educ.bl+household.income.bl+neighborhood_crime_y+rel_relationship+
                                      pmq_y_ss_mean+marital_allvisits+FH_Psychosis+TBIbin+(0+visit|src_subject_id)+(1 | abcd_site) + (1| rel_family_id), 
                                    family=nbinom2, data=com,  control = glmmTMBControl(parallel = 16))
  s <- summary(nb2modelFull5)
  est[[i]] <- s$coefficients$cond[, 1]
  se[[i]] <- s$coefficients$cond[, 2]
  rvar[[i]] <- 
    attr(glmmTMB::VarCorr(nb2modelFull5)[[1]]$"src_subject_id", "stddev")^2
  #rcor[[i]] <- cor2fisher(attr(
  # glmmTMB::VarCorr(nb2modelFull1)[[1]]$"ID",
  #"correlation"
  
}

s
#TBIbinYes                           0.0995364  0.0240527   4.138 3.50e-05 ***
exp(0.0995364)
#1.104659

exp(confint(nb2modelFull5))
#cond.TBIbinYes                          1.0537909  1.1579818  1.1046586

#################
